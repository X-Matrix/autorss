{
  "title": "Migrating my NAS from CoreOS/Flatcar Linux to NixOS",
  "link": "https://michael.stapelberg.ch/posts/2025-07-13-nixos-nas-network-storage-config/",
  "published": "2025-07-13T08:17:00+02:00",
  "summary": "<p>In this article, I want to show how to migrate an existing Linux server to NixOS\n‚Äî in my case the CoreOS/Flatcar Linux installation on my Network Attached\nStorage (NAS) PC.</p>\n<p>I will show in detail how the previous CoreOS setup looked like (lots of systemd\nunits starting Docker containers), how I migrated it into an intermediate state\n(using Docker on NixOS) just to get things going, and finally how I migrated all\nunits from Docker to native NixOS modules step-by-step.</p>\n<p>If you haven‚Äôt heard of NixOS, I recommend you read the <a href=\"https://nixos.org\">first page of the NixOS\nwebsite</a> to understand what NixOS is and what sort of things\nit makes possible.</p>\n<p>The target audience of this blog post is people interested in trying out NixOS\nfor the use-case of a NAS, who like seeing examples to understand how to\nconfigure a system.</p>\n<p>You can apply these examples by first following <a href=\"/posts/2025-06-01-nixos-installation-declarative/\">my blog post ‚ÄúHow I like to\ninstall NixOS\n(declaratively)‚Äù</a>, then\nmaking your way through the sections that interest you. If you prefer seeing the\nfull configuration, <a href=\"#conclusion\">skip to the conclusion</a>.</p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<a href=\"https://michael.stapelberg.ch/posts/2025-07-13-nixos-nas-network-storage-config/IMG_5563.jpg\"><img alt=\"PC NAS build from 2023\" height=\"479\" src=\"https://michael.stapelberg.ch/posts/2025-07-13-nixos-nas-network-storage-config/IMG_5563_hu_dfffd317a819e211.jpg\" style=\"border: 1px solid #000;\" title=\"PC NAS build from 2023\" width=\"600\" /></a>\n\n\n\n<h2 id=\"history\">Context/History</h2>\n<p>Over the last decade, I used a number of different operating systems for my\nNAS needs. Here‚Äôs an overview of the 2 NAS systems storage2 and storage3:</p>\n<table>\n  <thead>\n      <tr>\n          <th>Year</th>\n          <th>storage2</th>\n          <th>storage3</th>\n          <th>Details (blog post)</th>\n      </tr>\n  </thead>\n  <tbody>\n      <tr>\n          <td>2013</td>\n          <td>Debian on qnap</td>\n          <td>Debian on qnap</td>\n          <td><a href=\"/posts/2014-01-28-qnap_ts119_wol/\">Wake-On-LAN with Debian on a qnap TS-119P2+</a></td>\n      </tr>\n      <tr>\n          <td>2016</td>\n          <td>CoreOS on PC</td>\n          <td>CoreOS on PC</td>\n          <td><a href=\"/posts/2016-11-21-gigabit-nas-coreos/\">Gigabit NAS (running CoreOS)</a></td>\n      </tr>\n      <tr>\n          <td>2023</td>\n          <td>CoreOS on PC</td>\n          <td>Ubuntu+ZFS on PC</td>\n          <td><a href=\"/posts/2023-10-25-my-all-flash-zfs-network-storage-build/\">My all-flash ZFS NAS build</a></td>\n      </tr>\n      <tr>\n          <td>2025</td>\n          <td>NixOS on PC</td>\n          <td>Ubuntu+ZFS on PC</td>\n          <td>‚Üí you are here ‚Üê</td>\n      </tr>\n      <tr>\n          <td>?</td>\n          <td>NixOS on PC</td>\n          <td>NixOS+ZFS on PC</td>\n          <td>Converting more PCs to NixOS seems inevitable ;)</td>\n      </tr>\n  </tbody>\n</table>\n<h2 id=\"software-requirements\">My NAS Software Requirements</h2>\n<ul>\n<li>(This post is only about software! For my usage patterns and requirements\nregarding hardware selection, see <a href=\"/posts/2023-10-25-my-all-flash-zfs-network-storage-build/#design-goals\">‚ÄúDesign Goals‚Äù in my My all-flash ZFS NAS\nbuild post\n(2023)</a>.)</li>\n<li><strong>Remote management:</strong> I really like the model of having the configuration of\nmy network storage builds version-controlled and managed on my main PC. It‚Äôs a\nnice property that I can regain access to my backup setup by re-installing my\nNAS from my PC within minutes.</li>\n<li><strong>Automated updates, with easy rollback:</strong> Updating all my installations\nmanually is not my idea of a good time. Hence, automated updates are a must ‚Äî\nbut when the update breaks, a quick and easy path to recovery is also a\nmust.\n<ul>\n<li>CoreOS/Flatcar achieved that with an A/B updating scheme (update failed?\nboot the old partition), whereas NixOS achieves that with its concept of a\n‚Äúgeneration‚Äù (update failed? select the old generation), which is\nfiner-grained.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"why-migrate\">Why migrate from CoreOS/Flatcar to NixOS?</h2>\n<p>When I started using CoreOS, Docker was pretty new technology. I liked that\nusing Docker containers allowed you to treat services uniformly ‚Äî ultimately,\nthey all expose a port of some sort (speaking HTTP, or Postgres, or‚Ä¶), so you\ngot the flexibility to run much more recent versions of software on a stable OS,\nor older versions in case an update broke something.</p>\n<p>Over a decade later, Docker is established tech. People nowadays take for\ngranted the various benefits of the container approach.</p>\n<p>So, here‚Äôs my list of reasons why I wasn‚Äôt satisfied with Flatcar Linux anymore.</p>\n<h4 id=\"cloud-init\">R1. cloud-init is deprecated</h4>\n<p>The <a href=\"https://github.com/coreos/coreos-cloudinit\">CoreOS cloud-init</a> project was\ndeprecated at some point in favor of\n<a href=\"https://github.com/coreos/ignition\">Ignition</a>, which is clearly more powerful,\nbut also more cumbersome to get started with as a hobbyist. As far as I can\ntell, I must host my config at some URL that I then provide via a kernel\nparameter. The old way of just copying a file seems to no longer be supported.</p>\n<p>Ignition also seems less convenient in other ways: YAML is no longer supported,\nonly JSON, which I don‚Äôt enjoy writing by hand. Also, the format seems to\n<a href=\"https://coreos.github.io/ignition/migrating-configs/\">change quite a bit</a>.</p>\n<p>As a result, I never made the jump from cloud-init to Ignition, and it‚Äôs not\ngood to be reliant on a long-deprecated way to use your OS of choice.</p>\n<h4 id=\"container-bitrot\">R2. Container Bitrot</h4>\n<p>At some point, I did an audit of all my containers on the Docker Hub and noticed\nthat most of them were quite outdated. For a while, Docker Hub offered automated\nbuilds based on a <code>Dockerfile</code> obtained from GitHub. However, automated builds\nnow require a subscription, and I will not accept a subscription just to use my\nown computers.</p>\n<h4 id=\"r3-dependency-on-a-central-service\">R3. Dependency on a central service</h4>\n<p>If Docker at some point ceases operation of the Docker Hub, I am unable to\ndeploy software to my NAS. This isn‚Äôt a very hypothetical concern: In 2023,\nDocker Hub <a href=\"https://news.ycombinator.com/item?id=35154025\">announced the end of organizations on the Free\ntier</a> and then backpedaled after\ncommunity backlash.</p>\n<p>Who knows how long they can still provide free services to hobbyists like myself.</p>\n<h4 id=\"no-immich\">R4. Could not try Immich on Flatcar</h4>\n<p>The final nail in the coffin was when I noticed that I could not try Immich on\nmy NAS system! Modern web applications like Immich need multiple Docker\ncontainers (for Postgres, Redis, etc.) and hence only offer <a href=\"https://immich.app/docs/install/docker-compose\">Docker\nCompose</a> as a supported way of\ninstallation.</p>\n<p>Unfortunately, Flatcar <a href=\"https://github.com/flatcar/Flatcar/issues/894\">does not include Docker\nCompose</a>.</p>\n<p>I was not in the mood to re-package Immich for non-Docker-Compose systems on an\nongoing basis, so I decided that a system on which I can neither run software\nlike Immich directly, nor even run Docker Compose, is not sufficient for my\nneeds anymore.</p>\n<h4 id=\"reason-summary\">Reason Summary</h4>\n<p>With all of the above reasons, I would have had to set up automated container\nbuilds, run my own central registry and would still be unable to run well-known\nOpen Source software like Immich.</p>\n<p>Instead, I decided to try NixOS again (after a 10 year break) because it seems\nlike the most popular declarative solution nowadays, with a large community and\nlarge selection of packages.</p>\n<p>How does NixOS compare for my situation?</p>\n<ul>\n<li>Same: I also need to set up an automated job to update my NixOS systems.\n<ul>\n<li>I already have such a job for updating my <a href=\"https://gokrazy.org\">gokrazy</a> devices.</li>\n<li>Docker push is asynchronous: After a successful push, I still need extra\nautomation for pulling the updated containers on the target host and\nrestarting the affected services, whereas NixOS includes all of that.</li>\n</ul>\n</li>\n<li>Better: There is no central registry. With NixOS, I can push the build result\ndirectly to the target host via SSH.</li>\n<li>Better: The corpus of available software in NixOS is much larger (including\nImmich, for example) and the NixOS modules generally seem to be expressed at a\nhigher level of abstraction than individual Docker containers, meaning you can\nconfigure more features with fewer lines of config.</li>\n</ul>\n<h2 id=\"vm-prototyping\">Prototyping in a VM</h2>\n<p>My NAS setup needs to work every day, so I wanted to prototype my desired\nconfiguration in a VM before making changes to my system. This is not only\nsafer, it also allows me to discover any roadblocks, and what working with NixOS\nfeels like without making any commitments.</p>\n<p>I copied my NixOS configuration from a previous test installation (see <a href=\"/posts/2025-06-01-nixos-installation-declarative/\">‚ÄúHow I\nlike to install NixOS\n(declaratively)‚Äù</a>) and used\nthe following command to build a VM image and start it in QEMU:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-shell\"><span style=\"display: flex;\"><span>nix build .#nixosConfigurations.storage2.config.system.build.vm\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #007020;\">export</span> <span style=\"color: #bb60d5;\">QEMU_NET_OPTS</span><span style=\"color: #666;\">=</span><span style=\"color: #bb60d5;\">hostfwd</span><span style=\"color: #666;\">=</span>tcp::2222-:22\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #007020;\">export</span> <span style=\"color: #bb60d5;\">QEMU_KERNEL_PARAMS</span><span style=\"color: #666;\">=</span><span style=\"color: #bb60d5;\">console</span><span style=\"color: #666;\">=</span>ttyS0\n</span></span><span style=\"display: flex;\"><span>./result/bin/run-nixplay-vm\n</span></span></code></pre></div><p>The configuration instructions below can be tried out in this VM, and once\nyou‚Äôre happy enough with what you have, you can repeat the steps on the actual\nmachine to migrate.</p>\n<h2 id=\"migrating\">Migrating</h2>\n<p>For the migration of my actual system, I defined the following milestones that\nshould be achievable within a typical session of about an hour (after\nprototyping them in a VM):</p>\n<ul>\n<li>M1. Install NixOS</li>\n<li>M2. Set up remote disk unlock</li>\n<li>M3. Set up Samba for access</li>\n<li>M4. Set up SSH/rsync for backups</li>\n<li>Everything extra is nice-to-have and could be deferred to a future session on\nanother day.</li>\n</ul>\n<p>In practice, this worked out exactly as planned: the actual installation of\nNixOS and setting up my config to milestone M4 took a little over one hour. All\nthe other nice-to-haves were done over the following days and weeks as time\npermitted.</p>\n<p><strong>Tip:</strong> After losing data due to an installer bug in the 2000s, I have adopted\nthe habit of physically disconnecting all data disks (= pulling out the SATA\ncable) when re-installing the system disk.</p>\n<h3 id=\"m1-install-nixos\">M1. Install NixOS</h3>\n<p>After following <a href=\"/posts/2025-06-01-nixos-installation-declarative/\">‚ÄúHow I like to install NixOS\n(declaratively)‚Äù</a>, this is\nmy initial <code>configuration.nix</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>{ modulesPath<span style=\"color: #666;\">,</span> lib<span style=\"color: #666;\">,</span> pkgs<span style=\"color: #666;\">,</span> <span style=\"color: #666;\">...</span> }:\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>{\n</span></span><span style=\"display: flex;\"><span>  imports <span style=\"color: #666;\">=</span>\n</span></span><span style=\"display: flex;\"><span>    [\n</span></span><span style=\"display: flex;\"><span>      (modulesPath <span style=\"color: #666;\">+</span> <span style=\"color: #4070a0;\">\"/installer/scan/not-detected.nix\"</span>)\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #235388;\">./hardware-configuration.nix</span>\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #235388;\">./disk-config.nix</span>\n</span></span><span style=\"display: flex;\"><span>    ];\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># Adding michael as trusted user means</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># we can upgrade the system via SSH (see Makefile).</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  nix<span style=\"color: #666;\">.</span>settings<span style=\"color: #666;\">.</span>trusted-users <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"michael\"</span> <span style=\"color: #4070a0;\">\"root\"</span> ];\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># Clean the Nix store every week.</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  nix<span style=\"color: #666;\">.</span>gc <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    automatic <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    dates <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"weekly\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    options <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"--delete-older-than 7d\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  };\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  boot<span style=\"color: #666;\">.</span>loader<span style=\"color: #666;\">.</span>systemd-boot <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    configurationLimit <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">10</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  };\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  boot<span style=\"color: #666;\">.</span>loader<span style=\"color: #666;\">.</span>efi<span style=\"color: #666;\">.</span>canTouchEfiVariables <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  networking<span style=\"color: #666;\">.</span>hostName <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"storage2\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  time<span style=\"color: #666;\">.</span>timeZone <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"Europe/Zurich\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># Use systemd for networking</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  services<span style=\"color: #666;\">.</span>resolved<span style=\"color: #666;\">.</span>enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  networking<span style=\"color: #666;\">.</span>useDHCP <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">false</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  systemd<span style=\"color: #666;\">.</span>network<span style=\"color: #666;\">.</span>enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  systemd<span style=\"color: #666;\">.</span>network<span style=\"color: #666;\">.</span>networks<span style=\"color: #666;\">.</span><span style=\"color: #4070a0;\">\"10-e\"</span> <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    matchConfig<span style=\"color: #666;\">.</span>Name <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"e*\"</span>;  <span style=\"color: #60a0b0; font-style: italic;\"># enp9s0 (10G) or enp8s0 (1G)</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    networkConfig <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>      IPv6AcceptRA <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>      DHCP <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"yes\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    };\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  };\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  i18n<span style=\"color: #666;\">.</span>supportedLocales <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    <span style=\"color: #4070a0;\">\"en_DK.UTF-8/UTF-8\"</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    <span style=\"color: #4070a0;\">\"de_DE.UTF-8/UTF-8\"</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    <span style=\"color: #4070a0;\">\"de_CH.UTF-8/UTF-8\"</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    <span style=\"color: #4070a0;\">\"en_US.UTF-8/UTF-8\"</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  ];\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  i18n<span style=\"color: #666;\">.</span>defaultLocale <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"en_US.UTF-8\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  users<span style=\"color: #666;\">.</span>mutableUsers <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">false</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  security<span style=\"color: #666;\">.</span>sudo<span style=\"color: #666;\">.</span>wheelNeedsPassword <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">false</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  users<span style=\"color: #666;\">.</span>users<span style=\"color: #666;\">.</span>michael <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    openssh<span style=\"color: #666;\">.</span>authorizedKeys<span style=\"color: #666;\">.</span>keys <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>      <span style=\"color: #4070a0;\">\"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5secret\"</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>      <span style=\"color: #4070a0;\">\"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5key\"</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    ];\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    isNormalUser <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    description <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"Michael Stapelberg\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    extraGroups <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"networkmanager\"</span> <span style=\"color: #4070a0;\">\"wheel\"</span> ];\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    initialPassword <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"secret\"</span>;  <span style=\"color: #60a0b0; font-style: italic;\"># XXX: change!</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    shell <span style=\"color: #666;\">=</span> pkgs<span style=\"color: #666;\">.</span>zsh;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    packages <span style=\"color: #666;\">=</span> <span style=\"color: #007020; font-weight: bold;\">with</span> pkgs; [];\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  };\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  environment<span style=\"color: #666;\">.</span>systemPackages <span style=\"color: #666;\">=</span> <span style=\"color: #007020; font-weight: bold;\">with</span> pkgs; [\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    git  <span style=\"color: #60a0b0; font-style: italic;\"># for checking out github.com/stapelberg/configfiles</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    rsync\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    zsh\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    vim\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    emacs\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    wget\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    curl\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  ];\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  programs<span style=\"color: #666;\">.</span>zsh<span style=\"color: #666;\">.</span>enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  services<span style=\"color: #666;\">.</span>openssh<span style=\"color: #666;\">.</span>enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># This value determines the NixOS release from which the default</span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># settings for stateful data, like file locations and database versions</span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># on your system were taken. It‚Äòs perfectly fine and recommended to leave</span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># this value at the release version of the first install of this system.</span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># Before changing this value read the documentation for this option</span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># (e.g. man configuration.nix or on https://nixos.org/nixos/options.html).</span>\n</span></span><span style=\"display: flex;\"><span>  system<span style=\"color: #666;\">.</span>stateVersion <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"25.05\"</span>; <span style=\"color: #60a0b0; font-style: italic;\"># Did you read the comment?</span>\n</span></span><span style=\"display: flex;\"><span>}</span></span></code></pre></div>\n<p>All following sections describe changes within this <code>configuration.nix</code>.</p>\n<p>All devices in my home network obtain their IP address via DHCP. If I want to\nmake an IP address static, I configure it accordingly on my router.</p>\n<p>My NAS PCs have one specialty with regards to IP addressing: They are reachable\nvia IPv4 and IPv6, and the IPv6 address can be derived from the IPv4 address.</p>\n<p>Hence, I changed the systemd-networkd configuration from above such that it\nconfigures a static IPv6 address in a dynamically configured IPv6 network:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>network<span style=\"color: #666;\">.</span>networks<span style=\"color: #666;\">.</span><span style=\"color: #4070a0;\">\"10-e\"</span> <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    matchConfig<span style=\"color: #666;\">.</span>Name <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"e*\"</span>;  <span style=\"color: #60a0b0; font-style: italic;\"># enp9s0 (10G) or enp8s0 (1G)</span>\n</span></span><span style=\"display: flex;\"><span>    networkConfig <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>      IPv6AcceptRA <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>      DHCP <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"yes\"</span>;\n</span></span><span style=\"display: flex;\"><span>    };\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    ipv6AcceptRAConfig <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>      Token <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"::10:0:0:252\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    };\n</span></span><span style=\"display: flex;\"><span>  };</span></span></code></pre></div>\n<p>‚úÖ This fulfills milestone M1.</p>\n<h3 id=\"m2-set-up-remote-disk-unlock\">M2. Set up remote disk unlock</h3>\n<p>To unlock my encrypted disks on boot, I have a custom systemd service unit that\nuses <a href=\"https://manpages.debian.org/wget.1\"><code>wget(1)</code></a>\n and <a href=\"https://manpages.debian.org/cryptsetup.8\"><code>cryptsetup(8)</code></a>\n to split the key file between the NAS and a remote server (= an\nattacker needs both pieces to unlock).</p>\n<p>With CoreOS/Flatcar, my <code>cloud-init</code> configuration looked as follows:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-yaml\"><span style=\"display: flex;\"><span><span style=\"color: #062873; font-weight: bold;\">coreos</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">  </span><span style=\"color: #062873; font-weight: bold;\">units</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span>- <span style=\"color: #062873; font-weight: bold;\">name</span>:<span style=\"color: #bbb;\"> </span>unlock.service<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">      </span><span style=\"color: #062873; font-weight: bold;\">command</span>:<span style=\"color: #bbb;\"> </span>start<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">      </span><span style=\"color: #062873; font-weight: bold;\">content</span>:<span style=\"color: #bbb;\"> </span>|<span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        [Unit]\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Description=unlock hard drive\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Wants=network.target\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        After=systemd-networkd-wait-online.service\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Before=samba.service\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        [Service]\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Type=oneshot\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        RemainAfterExit=yes\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        # Wait until the host is actually reachable.\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStart=/bin/sh -c \"c=0; while [ $c -lt 5 ]; do /bin/ping6 -n -c 1 r.zekjur.net &amp;&amp; break; c=$((c+1)); sleep 1; done\"\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStart=/bin/sh -c \"[ -e \\\"/dev/mapper/S5SSNF0T205183F_crypt\\\" ] || (echo -n my_local_secret &amp;&amp; wget --retry-connrefused --ca-directory=/dev/null --ca-certificate=/etc/ssl/certs/r.zekjur.net.crt -qO - https://r.zekjur.net:8443/nascrypto) | /sbin/cryptsetup --key-file=- luksOpen /dev/disk/by-id/ata-Samsung_SSD_870_QVO_8TB_S5SSNF0T205183F S5SSNF0T205183F_crypt\"\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStart=/bin/sh -c \"[ -e \\\"/dev/mapper/S5SSNJ0T205991B_crypt\\\" ] || (echo -n my_local_secret &amp;&amp; wget --retry-connrefused --ca-directory=/dev/null --ca-certificate=/etc/ssl/certs/r.zekjur.net.crt -qO - https://r.zekjur.net:8443/nascrypto) | /sbin/cryptsetup --key-file=- luksOpen /dev/disk/by-id/ata-Samsung_SSD_870_QVO_8TB_S5SSNJ0T205991B S5SSNJ0T205991B_crypt\"\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStart=/bin/sh -c \"vgchange -ay\"\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStart=/bin/mount /dev/mapper/data-data /srv</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span><span style=\"color: #062873; font-weight: bold;\">write_files</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">  </span>- <span style=\"color: #062873; font-weight: bold;\">path</span>:<span style=\"color: #bbb;\"> </span>/etc/ssl/certs/r.zekjur.net.crt<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span><span style=\"color: #062873; font-weight: bold;\">content</span>:<span style=\"color: #bbb;\"> </span>|<span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">      -----BEGIN CERTIFICATE-----\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">      MIID8TCCAlmgAwIBAgIRAPWwvYWpoH+lGKv6rxZvC4MwDQYJKoZIhvcNAQELBQAw\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">      [‚Ä¶]\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">      -----END CERTIFICATE-----</span><span style=\"color: #bbb;\">\n</span></span></span></code></pre></div><p>I converted it into the following NixOS configuration:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>unlock <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"multi-user.target\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    description <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"unlock hard drive\"</span>;\n</span></span><span style=\"display: flex;\"><span>    wants <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"network.target\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    after <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"systemd-networkd-wait-online.service\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    serviceConfig <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>      Type <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"oneshot\"</span>;\n</span></span><span style=\"display: flex;\"><span>      RemainAfterExit <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"yes\"</span>;\n</span></span><span style=\"display: flex;\"><span>      ExecStart <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #60a0b0; font-style: italic;\"># Wait until the host is actually reachable.</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''/bin/sh -c \"c=0; while [ $c -lt 5 ]; do </span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>iputils<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/ping -n -c 1 r.zekjur.net &amp;&amp; break; c=$((c+1)); sleep 1; done\"''</span>\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''/bin/sh -c \"[ -e \\\"/dev/mapper/S5SSNF0T205183F_crypt\\\" ] || (echo -n my_local_secret &amp;&amp; </span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>wget<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/wget --retry-connrefused --ca-directory=/dev/null --ca-certificate=/etc/ssl/certs/r.zekjur.net.crt -qO - https://r.zekjur.net:8443/sdb2_crypt) | </span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>cryptsetup<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/cryptsetup --key-file=- luksOpen /dev/disk/by-id/ata-Samsung_SSD_870_QVO_8TB_S5SSNF0T205183F S5SSNF0T205183F_crypt\"''</span>\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''/bin/sh -c \"[ -e \\\"/dev/mapper/S5SSNJ0T205991B_crypt\\\" ] || (echo -n my_local_secret &amp;&amp; </span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>wget<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/wget --retry-connrefused --ca-directory=/dev/null --ca-certificate=/etc/ssl/certs/r.zekjur.net.crt -qO - https://r.zekjur.net:8443/sdc2_crypt) | </span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>cryptsetup<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/cryptsetup --key-file=- luksOpen /dev/disk/by-id/ata-Samsung_SSD_870_QVO_8TB_S5SSNJ0T205991B S5SSNJ0T205991B_crypt\"''</span>\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''/bin/sh -c \"</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>lvm2<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/vgchange -ay\"''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''/run/wrappers/bin/mount /dev/mapper/data-data /srv''</span>\n</span></span><span style=\"display: flex;\"><span>      ];\n</span></span><span style=\"display: flex;\"><span>    };\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><p>We‚Äôll also need to store the custom TLS certificate file on disk. For that, we\ncan use the <code>environment.</code> configuration:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  environment<span style=\"color: #666;\">.</span>etc<span style=\"color: #666;\">.</span><span style=\"color: #4070a0;\">\"ssl/certs/r.zekjur.net.crt\"</span><span style=\"color: #666;\">.</span>text <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">''\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">-----BEGIN CERTIFICATE-----\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">MIID8TCCAlmgAwIBAgIRAPWwvYWpoH+lGKv6rxZvC4MwDQYJKoZIhvcNAQELBQAw\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">[‚Ä¶]\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">-----END CERTIFICATE-----\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">''</span>;\n</span></span></code></pre></div><p>The references like <code>${pkgs.wget}</code> will be replaced with a path to the Nix store\n(<a href=\"https://nix.dev/tutorials/nix-language.html#paths\">‚Üí nix.dev\ndocumentation</a>). On\nCoreOS/Flatcar, I was limited to using just the (minimal set of) software\nincluded in the base image, or I had to reach for Docker. On NixOS, we can use\nall packages available in nixpkgs.</p>\n<p>After <a href=\"/posts/2025-06-01-nixos-installation-declarative/#making-changes\">deploying</a>\nand <code>reboot</code>ing, I can access my unlocked disk under <code>/srv</code>! üéâ</p>\n<pre tabindex=\"0\"><code>% df -h /srv\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/mapper/data-data   15T   14T  342G  98% /srv\n</code></pre><p>When listing my files, I noticed that the group id was different between my old\nsystem and the new system. This can be fixed by explicitly specifying the\ndesired group id:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  users<span style=\"color: #666;\">.</span>groups<span style=\"color: #666;\">.</span>michael <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    gid <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">1000</span>;  <span style=\"color: #60a0b0; font-style: italic;\"># for consistency with storage3</span>\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><p>‚úÖ M2 is complete.</p>\n<h3 id=\"m3-set-up-samba-for-access\">M3. Set up Samba for access</h3>\n<p>Whereas I want to configure remote disk unlock at the systemd service level, for\nSamba I want to use Docker: I wanted to first transfer my old (working)\nDocker-based setups as they are, and only later convert them to Nix.</p>\n<p>We enable the <a href=\"https://search.nixos.org/options?query=virtualisation.docker.enable\">Docker NixOS\nmodule</a>\nwhich sets up the daemons that Docker needs and whatever else is needed to make\nit work:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  virtualisation<span style=\"color: #666;\">.</span>docker<span style=\"color: #666;\">.</span>enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span></code></pre></div><p>This is already sufficient for other services to use Docker, but I also want to\nbe able to run the <code>docker</code> command interactively for debugging. Therefore, I\nadded <code>docker</code> to <code>systemPackages</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  environment<span style=\"color: #666;\">.</span>systemPackages <span style=\"color: #666;\">=</span> <span style=\"color: #007020; font-weight: bold;\">with</span> pkgs; [\n</span></span><span style=\"display: flex;\"><span>    git  <span style=\"color: #60a0b0; font-style: italic;\"># for checking out github.com/stapelberg/configfiles</span>\n</span></span><span style=\"display: flex;\"><span>    rsync\n</span></span><span style=\"display: flex;\"><span>    zsh\n</span></span><span style=\"display: flex;\"><span>    vim\n</span></span><span style=\"display: flex;\"><span>    emacs\n</span></span><span style=\"display: flex;\"><span>    wget\n</span></span><span style=\"display: flex;\"><span>    curl\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    docker\n</span></span><span style=\"display: flex;\"><span>  ];</span></span></code></pre></div>\n<p>After deploying this configuration, I can run <code>docker run -ti debian</code> to verify things work.</p>\n<p>The <code>cloud-init</code> version of samba looked like this:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-yaml\"><span style=\"display: flex;\"><span><span style=\"color: #062873; font-weight: bold;\">coreos</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">  </span><span style=\"color: #062873; font-weight: bold;\">units</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span>- <span style=\"color: #062873; font-weight: bold;\">name</span>:<span style=\"color: #bbb;\"> </span>samba.service<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">      </span><span style=\"color: #062873; font-weight: bold;\">command</span>:<span style=\"color: #bbb;\"> </span>start<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">      </span><span style=\"color: #062873; font-weight: bold;\">content</span>:<span style=\"color: #bbb;\"> </span>|<span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        [Unit]\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Description=samba server\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        After=docker.service unlock.mount\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Requires=docker.service unlock.mount\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        [Service]\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Restart=always\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        StartLimitInterval=0\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        # Always pull the latest version (bleeding edge).\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=-/usr/bin/docker pull stapelberg/docker-samba:latest\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        # Set up samba users (cannot be done in the (public) Dockerfile because\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        # users/passwords are sensitive information).\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=-/usr/bin/docker kill smb\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=-/usr/bin/docker rm smb\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=-/usr/bin/docker rm smb-prep\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=/usr/bin/docker run --name smb-prep stapelberg/docker-samba sh -c 'adduser --quiet --disabled-password --gecos \"\" --uid 29901 michael &amp;&amp; sed -i \"s,\\\\[global\\\\],[global]\\\\nserver multi channel support = yes\\\\naio read size = 1\\\\naio write size = 1,g\" /etc/samba/smb.conf'\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=/usr/bin/docker commit smb-prep smb-prepared\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=/usr/bin/docker rm smb-prep\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=/usr/bin/docker run --name smb-prep smb-prepared /bin/sh -c \"echo \\\"secret\\nsecret\\n\" | tee - | smbpasswd -a -s michael\"\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=/usr/bin/docker commit smb-prep smb-prepared\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStart=/usr/bin/docker run \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          -p 137:137 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          -p 138:138 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          -p 139:139 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          -p 445:445 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          --tmpfs=/run \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          -v /srv/data:/srv/data \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          --name smb \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          -t \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">          smb-prepared \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">            /usr/sbin/smbd --foreground --debug-stdout --no-process-group</span><span style=\"color: #bbb;\">\n</span></span></span></code></pre></div><p>We can translate this 1:1 to NixOS:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>samba <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"multi-user.target\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    description <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"samba server\"</span>;\n</span></span><span style=\"display: flex;\"><span>    after <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"unlock.service\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    requires <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"unlock.service\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    serviceConfig <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>      Restart <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"always\"</span>;\n</span></span><span style=\"display: flex;\"><span>      StartLimitInterval <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">0</span>;\n</span></span><span style=\"display: flex;\"><span>      ExecStartPre <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #60a0b0; font-style: italic;\"># Always pull the latest version.</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker pull stapelberg/docker-samba:latest''</span>\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #60a0b0; font-style: italic;\"># Set up samba users (cannot be done in the (public) Dockerfile because</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #60a0b0; font-style: italic;\"># users/passwords are sensitive information).</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker kill smb''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker rm smb''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker rm smb-prep''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker run --name smb-prep stapelberg/docker-samba sh -c 'adduser --quiet --disabled-password --gecos \"\" --uid 29901 michael &amp;&amp; sed -i \"s,\\\\[global\\\\],[global]\\\\nserver multi channel support = yes\\\\naio read size = 1\\\\naio write size = 1,g\" /etc/samba/smb.conf' ''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker commit smb-prep smb-prepared''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker rm smb-prep''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker run --name smb-prep smb-prepared /bin/sh -c \"echo \\\"secret\\nsecret\\n\" | tee - | smbpasswd -a -s michael\"''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker commit smb-prep smb-prepared''</span>\n</span></span><span style=\"display: flex;\"><span>      ];\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>      ExecStart <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker run \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           -p 137:137 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           -p 138:138 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           -p 139:139 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           -p 445:445 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           --tmpfs=/run \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           -v /srv/data:/srv/data \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           --name smb \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           -t \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">           smb-prepared \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">             /usr/sbin/smbd --foreground --debug-stdout --no-process-group\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">             ''</span>;\n</span></span><span style=\"display: flex;\"><span>    };\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span><span>}</span>\n</span></span></code></pre></div><p>‚úÖ Now I can manage my files over the network, which completes M3!</p>\n<p>See also: <a href=\"#samba-nixos\">Nice-to-haves: N5. samba from NixOS</a></p>\n<h3 id=\"m4-set-up-sshrsync-for-backups\">M4. Set up SSH/rsync for backups</h3>\n<p>For backing up data, I use rsync over SSH. I restrict this SSH access to run\nonly rsync commands by using <code>rrsync</code> (in a Docker container). To configure the\nSSH <a href=\"https://manpages.debian.org/authorized_keys.5\"><code>authorized_keys(5)</code></a>\n, we set:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  users<span style=\"color: #666;\">.</span>users<span style=\"color: #666;\">.</span>root<span style=\"color: #666;\">.</span>openssh<span style=\"color: #666;\">.</span>authorizedKeys<span style=\"color: #666;\">.</span>keys <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>    <span style=\"color: #4070a0;\">''command=\"</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker run --log-driver none -i -e SSH_ORIGINAL_COMMAND -v /srv/backup/midna:/srv/backup/midna stapelberg/docker-rsync /srv/backup/midna\" ssh-rsa AAAAB3Npublickey root@midna''</span>\n</span></span><span style=\"display: flex;\"><span>  <span>}</span>;\n</span></span></code></pre></div><p>‚úÖ A successful test backup run completes milestone M4!</p>\n<p>See also: <a href=\"#rrsync-nixos\">Nice-to-haves: N6. rrsync from NixOS</a></p>\n<h2 id=\"nice-to-haves\">Nice-to-haves</h2>\n<h3 id=\"prometheus-node-exporter\">N1. Prometheus Node Exporter</h3>\n<p>I like to monitor all my machines with <a href=\"https://prometheus.io\">Prometheus</a> (and\nGrafana). For network connectivity and authentication, I use the Tailscale mesh\nVPN.</p>\n<p>To install Tailscale, I <a href=\"https://search.nixos.org/options?query=services.tailscale.enable\">enable its NixOS\nmodule</a> and\nmake the <code>tailscale</code> command available:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  services<span style=\"color: #666;\">.</span>tailscale<span style=\"color: #666;\">.</span>enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>  environment<span style=\"color: #666;\">.</span>systemPackages <span style=\"color: #666;\">=</span> <span style=\"color: #007020; font-weight: bold;\">with</span> pkgs; [ tailscale ];\n</span></span></code></pre></div><p>After deploying, I run <code>sudo tailscale up</code> and open the login link in my browser.</p>\n<p>The Prometheus Node Exporter can also easily be enabled <a href=\"https://search.nixos.org/options?query=services.prometheus.exporters.node.enable\">through its NixOS\nmodule</a>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  services<span style=\"color: #666;\">.</span>prometheus<span style=\"color: #666;\">.</span>exporters<span style=\"color: #666;\">.</span>node <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    listenAddress <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"storage2.example.ts.net\"</span>;\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><p>However, this isn‚Äôt reliable yet: When Tailscale‚Äôs startup takes a while during\nsystem boot, the Node Exporter might burn through its entire restart budget when\nit cannot listen on the Tailscale IP address yet. We can enable <a href=\"/posts/2024-01-17-systemd-indefinite-service-restarts/\">indefinite\nrestarts</a> for the\nservice to eventually come up:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span><span style=\"color: #4070a0;\">\"prometheus-node-exporter\"</span> <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    startLimitIntervalSec <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">0</span>;\n</span></span><span style=\"display: flex;\"><span>    serviceConfig <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>      Restart <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"always\"</span>;\n</span></span><span style=\"display: flex;\"><span>      RestartSec <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">1</span>;\n</span></span><span style=\"display: flex;\"><span>    };\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><h3 id=\"reliable-mount\">N2. Reliable mounting</h3>\n<p>While migrating my setup, I noticed that calling <a href=\"https://manpages.debian.org/mount.8\"><code>mount(8)</code></a>\n from <code>unlock.service</code> directly is not reliable, and it‚Äôs better\nto let systemd manage the mounting:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  fileSystems<span style=\"color: #666;\">.</span><span style=\"color: #4070a0;\">\"/srv\"</span> <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    device <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"/dev/mapper/data-data\"</span>;\n</span></span><span style=\"display: flex;\"><span>    fsType <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"ext4\"</span>;\n</span></span><span style=\"display: flex;\"><span>    options <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #4070a0;\">\"nofail\"</span>\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #4070a0;\">\"x-systemd.requires=unlock.service\"</span>\n</span></span><span style=\"display: flex;\"><span>    ];\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><p>Afterwards, I could just remove the <a href=\"https://manpages.debian.org/mount.8\"><code>mount(8)</code></a>\n call\nfrom <code>unlock.service</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-diff\"><span style=\"display: flex;\"><span><span style=\"color: #800080; font-weight: bold;\">@@ -247,7 +247,10 @@ fry/U6A=\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #800080; font-weight: bold;\"></span>         ''/bin/sh -c \"${pkgs.lvm2.bin}/bin/vgchange -ay\"''\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #a00000;\">-        ''/run/wrappers/bin/mount /dev/mapper/data-data /srv''\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #a00000;\"></span><span style=\"color: #00a000;\">+        # Let systemd mount /srv based on the fileSystems./srv\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #00a000;\">+        # declaration to prevent race conditions: mount\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #00a000;\">+        # might not succeed while the fsck is still in progress,\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #00a000;\">+        # for example, which otherwise makes unlock.service fail.\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #00a000;\"></span>       ];\n</span></span><span style=\"display: flex;\"><span>     };\n</span></span></code></pre></div><p>In systemd services, I can now depend on the <code>/srv</code> mount unit:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>jellyfin <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    unitConfig<span style=\"color: #666;\">.</span>RequiresMountsFor <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"/srv\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"srv.mount\"</span> ];\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><h3 id=\"nginx-healthz\">N3. nginx-healthz</h3>\n<p>To save power, I turn off my NAS when they are not in use.</p>\n<p>My backup orchestration uses Wake-on-LAN to start a wakeup and needs to wait\nuntil the NAS is fully booted up and has mounted its <code>/srv</code> mount before it\ncan start backup jobs.</p>\n<p>For this purpose, I have configured a web server (without any files) that\ndepends on the <code>/srv</code> mount. So, once the web server responds to HTTP requests,\nwe know <code>/srv</code> is mounted.</p>\n<p>The <code>cloud-init</code> config looked as follows:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-yaml\"><span style=\"display: flex;\"><span><span style=\"color: #062873; font-weight: bold;\">coreos</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">  </span><span style=\"color: #062873; font-weight: bold;\">units</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span>- <span style=\"color: #062873; font-weight: bold;\">name</span>:<span style=\"color: #bbb;\"> </span>healthz.service<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">      </span><span style=\"color: #062873; font-weight: bold;\">command</span>:<span style=\"color: #bbb;\"> </span>start<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">      </span><span style=\"color: #062873; font-weight: bold;\">content</span>:<span style=\"color: #bbb;\"> </span>|<span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        [Unit]\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Description=nginx for /srv health check\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Wants=network.target\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        After=srv.mount\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Requires=srv.mount\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        StartLimitInterval=0\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        [Service]\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        Restart=always\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=/bin/sh -c 'systemctl is-active docker.service'\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=/usr/bin/docker pull nginx:1\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=-/usr/bin/docker kill nginx-healthz\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStartPre=-/usr/bin/docker rm -f nginx-healthz\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">        ExecStart=/usr/bin/docker run \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">            --name nginx-healthz \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">            --publish 10.0.0.252:8200:80 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">            --log-driver=journald \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-style: italic;\">            nginx:1</span><span style=\"color: #bbb;\">\n</span></span></span></code></pre></div><p>The Docker version (ported from Flatcar Linux) looks like this:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>healthz <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    description <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"nginx for /srv health check\"</span>;\n</span></span><span style=\"display: flex;\"><span>    wants <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"network.target\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    unitConfig<span style=\"color: #666;\">.</span>RequiresMountsFor <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"/srv\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"srv.mount\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    startLimitIntervalSec <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">0</span>;\n</span></span><span style=\"display: flex;\"><span>    serviceConfig <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>      Restart <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"always\"</span>;\n</span></span><span style=\"display: flex;\"><span>      ExecStartPre <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''/bin/sh -c 'systemctl is-active docker.service' ''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker pull nginx:1''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker kill nginx-healthz''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker rm -f nginx-healthz''</span>\n</span></span><span style=\"display: flex;\"><span>      ];\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>      ExecStart <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker run \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">            --name nginx-healthz \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">            --publish 10.0.0.252:8200:80 \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">            --log-driver=journald \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">            nginx:1\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        ''</span>\n</span></span><span style=\"display: flex;\"><span>      ];\n</span></span><span style=\"display: flex;\"><span>    };\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><p>This configuration gets a lot simpler when migrating it from Docker to NixOS:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># Signal readiness on HTTP port 8200 once /srv is mounted:</span>\n</span></span><span style=\"display: flex;\"><span>  networking<span style=\"color: #666;\">.</span>firewall<span style=\"color: #666;\">.</span>allowedTCPPorts <span style=\"color: #666;\">=</span> [ <span style=\"color: #40a070;\">8200</span> ];\n</span></span><span style=\"display: flex;\"><span>  services<span style=\"color: #666;\">.</span>caddy <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    virtualHosts<span style=\"color: #666;\">.</span><span style=\"color: #4070a0;\">\"http://10.0.0.252:8200\"</span><span style=\"color: #666;\">.</span>extraConfig <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">''\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">      respond \"ok\"\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    ''</span>;\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>caddy <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    unitConfig<span style=\"color: #666;\">.</span>RequiresMountsFor <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"/srv\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"srv.mount\"</span> ];\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><h3 id=\"jellyfin\">N4. NixOS Jellyfin</h3>\n<p>The Docker version (ported from Flatcar Linux) looks like this:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  networking<span style=\"color: #666;\">.</span>firewall<span style=\"color: #666;\">.</span>allowedTCPPorts <span style=\"color: #666;\">=</span> [ <span style=\"color: #40a070;\">4414</span> <span style=\"color: #40a070;\">8096</span> ];\n</span></span><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>jellyfin <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"multi-user.target\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    description <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"jellyfin\"</span>;\n</span></span><span style=\"display: flex;\"><span>    after <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"docker.service\"</span> <span style=\"color: #4070a0;\">\"srv.mount\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    requires <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"docker.service\"</span> <span style=\"color: #4070a0;\">\"srv.mount\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    startLimitIntervalSec <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">0</span>;\n</span></span><span style=\"display: flex;\"><span>    serviceConfig <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>      Restart <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"always\"</span>;\n</span></span><span style=\"display: flex;\"><span>      ExecStartPre <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker pull lscr.io/linuxserver/jellyfin:latest''</span>\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker rm jellyfin''</span>\n</span></span><span style=\"display: flex;\"><span>      ];\n</span></span><span style=\"display: flex;\"><span>      ExecStart <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">''-</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker run \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          --rm \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          --net=host \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          --name=jellyfin \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          -e TZ=Europe/Zurich \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          -v /srv/jellyfin/config:/config \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          -v /srv/data/movies:/data/movies:ro \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          -v /srv/data/series:/data/series:ro \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          -v /srv/data/mp3:/data/mp3:ro \\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">          lscr.io/linuxserver/jellyfin:latest\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        ''</span>\n</span></span><span style=\"display: flex;\"><span>      ];\n</span></span><span style=\"display: flex;\"><span>    };\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><p>As before, when using jellyfin from NixOS, the configuration gets simpler:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  services<span style=\"color: #666;\">.</span>jellyfin <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    openFirewall <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>jellyfin <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    unitConfig<span style=\"color: #666;\">.</span>RequiresMountsFor <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"/srv\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"srv.mount\"</span> ];\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><p>For a while, I had also set up compatibility symlinks that map the old location\n(<code>/data/movies</code>, inside the Docker container) to the new location\n(<code>/srv/data/movies</code>), but I encountered strange issues in Jellyfin and ended up\njust re-initializing my whole Jellyfin state. While the required configuration\nhad more lines, I found it neat to move it into its own file, so here is how to\ndo that:</p>\n<p>Remove the lines above from <code>configuration.nix</code> and move them into\n<code>jellyfin.nix</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>{\n</span></span><span style=\"display: flex;\"><span>  config<span style=\"color: #666;\">,</span>\n</span></span><span style=\"display: flex;\"><span>  lib<span style=\"color: #666;\">,</span>\n</span></span><span style=\"display: flex;\"><span>  pkgs<span style=\"color: #666;\">,</span>\n</span></span><span style=\"display: flex;\"><span>  modulesPath<span style=\"color: #666;\">,</span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #666;\">...</span>\n</span></span><span style=\"display: flex;\"><span>}:\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>{\n</span></span><span style=\"display: flex;\"><span>  services<span style=\"color: #666;\">.</span>jellyfin <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    openFirewall <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    dataDir <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"/srv/jellyfin\"</span>;\n</span></span><span style=\"display: flex;\"><span>    cacheDir <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"/srv/jellyfin/config/cache\"</span>;\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>jellyfin <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    unitConfig<span style=\"color: #666;\">.</span>RequiresMountsFor <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"/srv\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"srv.mount\"</span> ];\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>}\n</span></span></code></pre></div><p>Then, in <code>configuration.nix</code>, add <code>jellyfin.nix</code> to the <code>imports</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>   imports <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>     <span style=\"color: #235388;\">./hardware-configuration.nix</span>\n</span></span><span style=\"display: flex;\"><span>     <span style=\"color: #235388;\">./jellyfin.nix</span>\n</span></span><span style=\"display: flex;\"><span>   ];\n</span></span></code></pre></div><h3 id=\"samba-nixos\">N5. NixOS samba</h3>\n<p>To use Samba from NixOS, I replaced my <code>systemd.services.samba</code> config from M3\nwith this:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  services<span style=\"color: #666;\">.</span>samba <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    openFirewall <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    settings <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #4070a0;\">\"global\"</span> <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">\"map to guest\"</span> <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"bad user\"</span>;\n</span></span><span style=\"display: flex;\"><span>      };\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #4070a0;\">\"data\"</span> <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">\"path\"</span> <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"/srv/data\"</span>;\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">\"comment\"</span> <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"public data\"</span>;\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">\"read only\"</span> <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"no\"</span>;\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">\"create mask\"</span> <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"0775\"</span>;\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">\"directory mask\"</span> <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"0775\"</span>;\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #4070a0;\">\"guest ok\"</span> <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"yes\"</span>;\n</span></span><span style=\"display: flex;\"><span>      };\n</span></span><span style=\"display: flex;\"><span>    };\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>  system<span style=\"color: #666;\">.</span>activationScripts<span style=\"color: #666;\">.</span>samba_user_create <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">''\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">      smb_password=\"secret\"\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">      echo -e \"$smb_password\\n$smb_password\\n\" | </span><span style=\"color: #70a0d0;\">${</span>lib<span style=\"color: #666;\">.</span>getExe' pkgs<span style=\"color: #666;\">.</span>samba <span style=\"color: #4070a0;\">\"smbpasswd\"</span><span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\"> -a -s michael\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    ''</span>;\n</span></span></code></pre></div><p>Note: Setting the samba password in the activation script works for small\nsetups, but if you want to keep your samba passwords out of the Nix store,\nyou‚Äôll need to use a different approach. On a different machine, I use\n<a href=\"https://github.com/Mic92/sops-nix\">sops-nix</a> to manage secrets and found that\nrefactoring the <code>smbpasswd</code> call like so works reliably:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span><span style=\"color: #007020; font-weight: bold;\">let</span>\n</span></span><span style=\"display: flex;\"><span>  setPasswords <span style=\"color: #666;\">=</span> pkgs<span style=\"color: #666;\">.</span>writeShellScript <span style=\"color: #4070a0;\">\"samba-set-passwords\"</span> <span style=\"color: #4070a0;\">''\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    set -euo pipefail\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    for user in michael; do\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        smb_password=\"$(cat /run/secrets/samba_passwords/$user)\"\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        echo -e \"$smb_password\\n$smb_password\\n\" | </span><span style=\"color: #70a0d0;\">${</span>lib<span style=\"color: #666;\">.</span>getExe' pkgs<span style=\"color: #666;\">.</span>samba <span style=\"color: #4070a0;\">\"smbpasswd\"</span><span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\"> -a -s $user\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    done\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">  ''</span>;\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #007020; font-weight: bold;\">in</span>\n</span></span><span style=\"display: flex;\"><span> {\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># ‚Ä¶</span>\n</span></span><span style=\"display: flex;\"><span>  services<span style=\"color: #666;\">.</span>samba <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    <span style=\"color: #60a0b0; font-style: italic;\"># ‚Ä¶as above‚Ä¶</span>\n</span></span><span style=\"display: flex;\"><span>  }\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span>samba-smbd<span style=\"color: #666;\">.</span>serviceConfig<span style=\"color: #666;\">.</span>ExecStartPre <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>    <span style=\"color: #4070a0;\">\"</span><span style=\"color: #70a0d0;\">${</span>setPasswords<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">\"</span>\n</span></span><span style=\"display: flex;\"><span>  ];\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  sops<span style=\"color: #666;\">.</span>secrets<span style=\"color: #666;\">.</span><span style=\"color: #4070a0;\">\"samba_passwords/michael\"</span> <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    restartUnits <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"samba-smbd.service\"</span> ];\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>}\n</span></span></code></pre></div><p>I also noticed that NixOS does not create a group for each user by default, but\nI am used to managing my permissions like that. We can easily declare a group\nlike so:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  users<span style=\"color: #666;\">.</span>groups<span style=\"color: #666;\">.</span>michael <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    gid <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">1000</span>; <span style=\"color: #60a0b0; font-style: italic;\"># for consistency with storage3</span>\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>  users<span style=\"color: #666;\">.</span>users<span style=\"color: #666;\">.</span>michael <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    extraGroups <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #4070a0;\">\"wheel\"</span> <span style=\"color: #60a0b0; font-style: italic;\"># Enable ‚Äòsudo‚Äô for the user.</span>\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #4070a0;\">\"docker\"</span>\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #60a0b0; font-style: italic;\"># By default, NixOS does not add users to their own group:</span>\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #60a0b0; font-style: italic;\"># https://github.com/NixOS/nixpkgs/issues/198296</span>\n</span></span><span style=\"display: flex;\"><span>      <span style=\"color: #4070a0;\">\"michael\"</span>\n</span></span><span style=\"display: flex;\"><span>    ];\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><h3 id=\"rrsync-nixos\">N6. NixOS rrsync</h3>\n<p>The Docker version (ported from Flatcar Linux) looks like this:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  users<span style=\"color: #666;\">.</span>users<span style=\"color: #666;\">.</span>root<span style=\"color: #666;\">.</span>openssh<span style=\"color: #666;\">.</span>authorizedKeys<span style=\"color: #666;\">.</span>keys <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>    <span style=\"color: #4070a0;\">''command=\"</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker run --log-driver none -i -e SSH_ORIGINAL_COMMAND -v /srv/backup/midna:/srv/backup/midna stapelberg/docker-rsync /srv/backup/midna\" ssh-rsa AAAAB3Npublickey root@midna''</span>\n</span></span><span style=\"display: flex;\"><span>  ];\n</span></span></code></pre></div><p>To use <code>rrsync</code> from NixOS, I changed the configuration like so:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  users<span style=\"color: #666;\">.</span>users<span style=\"color: #666;\">.</span>root<span style=\"color: #666;\">.</span>openssh<span style=\"color: #666;\">.</span>authorizedKeys<span style=\"color: #666;\">.</span>keys <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>    <span style=\"color: #4070a0;\">''command=\"</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>rrsync<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/rrsync /srv/backup/midna\" ssh-rsa AAAAB3Npublickey root@midna''</span>\n</span></span><span style=\"display: flex;\"><span>  ];\n</span></span></code></pre></div><h3 id=\"syncpl-nixos\">N7. sync.pl script</h3>\n<p>The Docker version (ported from Flatcar Linux) looks like this:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  users<span style=\"color: #666;\">.</span>users<span style=\"color: #666;\">.</span>root<span style=\"color: #666;\">.</span>openssh<span style=\"color: #666;\">.</span>authorizedKeys<span style=\"color: #666;\">.</span>keys <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>    <span style=\"color: #4070a0;\">''command=\"</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>docker<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/docker run --log-driver none -i -e SSH_ORIGINAL_COMMAND -v /srv/data:/srv/data -v /root/.ssh:/root/.ssh:ro -v /etc/ssh:/etc/ssh:ro -v /etc/static/ssh:/etc/static/ssh:ro -v /nix/store:/nix/store:ro stapelberg/docker-sync\",no-port-forwarding,no-X11-forwarding ssh-ed25519 AAAAC3Npublickey sync@dr''</span>\n</span></span><span style=\"display: flex;\"><span>  ];\n</span></span></code></pre></div><p>I wanted to stop managing the following <code>Dockerfile</code> to ship <code>sync.pl</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-Dockerfile\"><span style=\"display: flex;\"><span><span style=\"color: #007020; font-weight: bold;\">FROM</span><span style=\"color: #bbb;\"> </span><span style=\"color: #4070a0;\">debian:stable</span><span>\n</span></span></span><span style=\"display: flex;\"><span><span>\n</span></span></span><span style=\"display: flex;\"><span><span></span><span style=\"color: #60a0b0; font-style: italic;\"># Install full perl for Data::Dumper</span><span>\n</span></span></span><span style=\"display: flex;\"><span><span></span><span style=\"color: #007020; font-weight: bold;\">RUN</span> apt-get update <span style=\"color: #4070a0; font-weight: bold;\">\\\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0; font-weight: bold;\"></span>    <span style=\"color: #666;\">&amp;&amp;</span> apt-get install -y rsync ssh perl<span>\n</span></span></span><span style=\"display: flex;\"><span><span>\n</span></span></span><span style=\"display: flex;\"><span><span></span><span style=\"color: #007020; font-weight: bold;\">ADD</span> sync.pl /usr/bin/<span>\n</span></span></span><span style=\"display: flex;\"><span><span>\n</span></span></span><span style=\"display: flex;\"><span><span></span><span style=\"color: #007020; font-weight: bold;\">ENTRYPOINT</span> [<span style=\"color: #4070a0;\">\"/usr/bin/sync.pl\"</span>]<span>\n</span></span></span></code></pre></div><p>To get rid of the Docker container, I translated the <code>sync.pl</code> file into a Nix\nexpression that writes the <code>sync.pl</code> Perl script to the Nix store:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>{ pkgs }:\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #60a0b0; font-style: italic;\"># For string literal escaping rules (''${), see:</span>\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #60a0b0; font-style: italic;\"># https://nix.dev/manual/nix/2.26/language/string-literals#string-literals</span>\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #60a0b0; font-style: italic;\"># For writers.writePerlBin, see https://wiki.nixos.org/wiki/Nix-writers</span>\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>pkgs<span style=\"color: #666;\">.</span>writers<span style=\"color: #666;\">.</span>writePerlBin <span style=\"color: #4070a0;\">\"syncpl\"</span> { libraries <span style=\"color: #666;\">=</span> []; } <span style=\"color: #4070a0;\">''\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\"># This script is run via ssh from dornr√∂schen.\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">use strict;\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">use warnings;\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">use Data::Dumper;\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">if (my ($destination) = ($ENV{SSH_ORIGINAL_COMMAND} =~ /^([a-z0-9.]+)$/)) {\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    print STDERR \"rsync version: \" . `</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>rsync<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/rsync --version` . \"\\n\\n\";\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    my @rsync = (\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"</span><span style=\"color: #70a0d0;\">${</span>pkgs<span style=\"color: #666;\">.</span>rsync<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/rsync\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"-e\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"ssh\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"--max-delete=-1\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"--verbose\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"--stats\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        # Intentionally not setting -X for my data sync,\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        # where there are no full system backups; mostly media files.\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"-ax\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"--ignore-existing\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"--omit-dir-times\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"/srv/data/\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">        \"</span><span style=\"color: #4070a0; font-weight: bold;\">''$</span><span style=\"color: #4070a0;\">{destination}:/\",\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    );\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    print STDERR \"running: \" . Dumper(\\@rsync) . \"\\n\";\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    exec @rsync;\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">} else {\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">    print STDERR \"Could not parse SSH_ORIGINAL_COMMAND.\\n\";\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">}\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #4070a0;\">''</span>\n</span></span></code></pre></div><p>I can then reference this file by importing it in my <code>configuration.nix</code> and\npointing it to the <code>pkgs</code> expression of my NixOS configuration:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>{ modulesPath<span style=\"color: #666;\">,</span> lib<span style=\"color: #666;\">,</span> pkgs<span style=\"color: #666;\">,</span> <span style=\"color: #666;\">...</span> }:\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span><span style=\"color: #007020; font-weight: bold;\">let</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  syncpl <span style=\"color: #666;\">=</span> <span style=\"color: #007020; font-weight: bold;\">import</span> <span style=\"color: #235388;\">./syncpl.nix</span> { pkgs <span style=\"color: #666;\">=</span> pkgs; };\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span><span style=\"color: #007020; font-weight: bold;\">in</span> {\n</span></span><span style=\"display: flex;\"><span>  imports <span style=\"color: #666;\">=</span> [ <span style=\"color: #235388;\">./hardware-configuration.nix</span> ];\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  users<span style=\"color: #666;\">.</span>users<span style=\"color: #666;\">.</span>root<span style=\"color: #666;\">.</span>openssh<span style=\"color: #666;\">.</span>authorizedKeys<span style=\"color: #666;\">.</span>keys <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    <span style=\"color: #4070a0;\">''command=\"</span><span style=\"color: #70a0d0;\">${</span>syncpl<span style=\"color: #70a0d0;\">}</span><span style=\"color: #4070a0;\">/bin/syncpl\",no-port-forwarding,no-X11-forwarding ssh-ed25519 AAAAC3Npublickey sync@dr''</span>\n</span></span><span style=\"display: flex;\"><span>  ];\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># For interactive usage (when debugging):</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>  environment<span style=\"color: #666;\">.</span>systemPackages <span style=\"color: #666;\">=</span> [ syncpl ];\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># ‚Ä¶</span>\n</span></span><span style=\"display: flex;\"><span>}</span></span></code></pre></div>\n<p>This works, but is it the best approach? Here are some thoughts:</p>\n<ul>\n<li>By managing this script in a Nix expression, I can no longer use my editor‚Äôs\nPerl support.\n<ul>\n<li>I could probably also keep <code>sync.pl</code> as a separate file and use string\ninterpolation in my Nix expression to inject an absolute path to the <code>rsync</code>\nbinary into the script.</li>\n</ul>\n</li>\n<li>Another alternative would be to add a wrapper script to my Nix expression\nwhich ensures that <code>$PATH</code> contains <code>rsync</code> and then the script wouldn‚Äôt need\nan absolute path anymore.</li>\n<li>For small glue scripts like this one, I consider it easier to manage the\ncontents ‚Äúinline‚Äù in the Nix expression, because it means one fewer file in my\nconfig directory.</li>\n</ul>\n<h3 id=\"flakes\">N8. Sharing configs</h3>\n<p>I want to configure all my NixOS systems such that my user settings are\nidentical everywhere.</p>\n<p>To achieve that, I can extract parts of my <code>configuration.nix</code> into a\n<a href=\"https://github.com/stapelberg/nix/blob/main/user-settings.nix\"><code>user-settings.nix</code></a>\nand then <a href=\"https://github.com/stapelberg/nix/blob/30cdd7db9e0ab4b7cc3a38b7953e1b7e1e238d75/flake.nix#L7\">declare an accompanying\n<code>flake.nix</code></a>\nthat provides this expression as an output.</p>\n<p>After publishing these files in a git repository, I can reference said\nrepository in my <code>flake.nix</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>{\n</span></span><span style=\"display: flex;\"><span>  inputs <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    nixpkgs<span style=\"color: #666;\">.</span>url <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"github:nixos/nixpkgs/nixos-25.05\"</span>;\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>    stapelbergnix<span style=\"color: #666;\">.</span>url <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"github:stapelberg/nix\"</span>;\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  outputs <span style=\"color: #666;\">=</span>\n</span></span><span style=\"display: flex;\"><span>    {\n</span></span><span style=\"display: flex;\"><span>      self<span style=\"color: #666;\">,</span>\n</span></span><span style=\"display: flex;\"><span>      nixpkgs<span style=\"color: #666;\">,</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>\t  stapelbergnix<span style=\"color: #666;\">,</span>\n</span></span><span style=\"display: flex;\"><span>    }:\n</span></span><span style=\"display: flex;\"><span>    <span style=\"color: #007020; font-weight: bold;\">let</span>\n</span></span><span style=\"display: flex;\"><span>      system <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"x86_64-linux\"</span>;\n</span></span><span style=\"display: flex;\"><span>      pkgs <span style=\"color: #666;\">=</span> <span style=\"color: #007020; font-weight: bold;\">import</span> nixpkgs {\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #007020; font-weight: bold;\">inherit</span> system;\n</span></span><span style=\"display: flex;\"><span>        config<span style=\"color: #666;\">.</span>allowUnfree <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">false</span>;\n</span></span><span style=\"display: flex;\"><span>      };\n</span></span><span style=\"display: flex;\"><span>    <span style=\"color: #007020; font-weight: bold;\">in</span>\n</span></span><span style=\"display: flex;\"><span>    {\n</span></span><span style=\"display: flex;\"><span>      nixosConfigurations<span style=\"color: #666;\">.</span>storage2 <span style=\"color: #666;\">=</span> nixpkgs<span style=\"color: #666;\">.</span>lib<span style=\"color: #666;\">.</span>nixosSystem {\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #007020; font-weight: bold;\">inherit</span> system;\n</span></span><span style=\"display: flex;\"><span>        <span style=\"color: #007020; font-weight: bold;\">inherit</span> pkgs;\n</span></span><span style=\"display: flex;\"><span>        modules <span style=\"color: #666;\">=</span> [\n</span></span><span style=\"display: flex;\"><span>          <span style=\"color: #235388;\">./configuration.nix</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>          stapelbergnix<span style=\"color: #666;\">.</span>lib<span style=\"color: #666;\">.</span>userSettings\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>          <span style=\"color: #60a0b0; font-style: italic;\"># Not on this machine; We have our own networking config:</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>          <span style=\"color: #60a0b0; font-style: italic;\"># stapelbergnix.lib.systemdNetwork</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>          <span style=\"color: #60a0b0; font-style: italic;\"># Use systemd-boot as bootloader</span>\n</span></span><span style=\"display: flex; background-color: #d8d8d8;\"><span>          stapelbergnix<span style=\"color: #666;\">.</span>lib<span style=\"color: #666;\">.</span>systemdBoot\n</span></span><span style=\"display: flex;\"><span>        ];\n</span></span><span style=\"display: flex;\"><span>      };\n</span></span><span style=\"display: flex;\"><span>      formatter<span style=\"color: #666;\">.</span><span style=\"color: #70a0d0;\">${</span>system<span style=\"color: #70a0d0;\">}</span> <span style=\"color: #666;\">=</span> pkgs<span style=\"color: #666;\">.</span>nixfmt-tree;\n</span></span><span style=\"display: flex;\"><span>    };\n</span></span><span style=\"display: flex;\"><span>}</span></span></code></pre></div>\n<p>Everything <a href=\"https://github.com/stapelberg/nix/blob/main/user-settings.nix\">declared in the\n<code>user-settings.nix</code></a>\ncan now be removed from <code>configuration.nix</code>!</p>\n<h3 id=\"immich-nixos\">N9. Trying immich!</h3>\n<p>One of the motivating reasons for switching away from CoreOS/Flatcar was that I\ncouldn‚Äôt try Immich, so let‚Äôs give it a shot on NixOS:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-nix\"><span style=\"display: flex;\"><span>  services<span style=\"color: #666;\">.</span>immich <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    enable <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    host <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"10.0.0.252\"</span>;\n</span></span><span style=\"display: flex;\"><span>    port <span style=\"color: #666;\">=</span> <span style=\"color: #40a070;\">2283</span>;\n</span></span><span style=\"display: flex;\"><span>    openFirewall <span style=\"color: #666;\">=</span> <span style=\"color: #60add5;\">true</span>;\n</span></span><span style=\"display: flex;\"><span>    mediaLocation <span style=\"color: #666;\">=</span> <span style=\"color: #4070a0;\">\"/srv/immich\"</span>;\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span><span style=\"display: flex;\"><span>\n</span></span><span style=\"display: flex;\"><span>  <span style=\"color: #60a0b0; font-style: italic;\"># Because /srv is a separate file system, we need to declare:</span>\n</span></span><span style=\"display: flex;\"><span>  systemd<span style=\"color: #666;\">.</span>services<span style=\"color: #666;\">.</span><span style=\"color: #4070a0;\">\"immich-server\"</span> <span style=\"color: #666;\">=</span> {\n</span></span><span style=\"display: flex;\"><span>    unitConfig<span style=\"color: #666;\">.</span>RequiresMountsFor <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"/srv\"</span> ];\n</span></span><span style=\"display: flex;\"><span>    wantedBy <span style=\"color: #666;\">=</span> [ <span style=\"color: #4070a0;\">\"srv.mount\"</span> ];\n</span></span><span style=\"display: flex;\"><span>  };\n</span></span></code></pre></div><h2 id=\"conclusion\">Conclusion</h2>\n<p>You can find the <a href=\"https://github.com/stapelberg/zkj-nas-tools/tree/master/_2025-07-nixos-nas-configs\">full configuration directory on\nGitHub</a>.</p>\n<p>I am pretty happy with this NixOS setup! Previously (with CoreOS/Flatcar), I\ncould declaratively manage my base system, but had to manage tons of Docker\ncontainers in addition. With NixOS, I can declaratively manage <em>everything</em> (or\nas much as makes sense).</p>\n<p>Custom configuration like my SSH+rsync-based backup infrastructure can be\nexpressed cleanly, in one place, and structured at the desired level of\nabstraction/reuse.</p>\n<p>If you‚Äôre considering managing at least one other system with NixOS, I would\nrecommend it! One of my follow-up projects is to convert storage3 (my other NAS\nbuild) from Ubuntu Server to NixOS as well to cut down on manual\nmanagement. Being able to just copy the entire config to set up another system,\nor try out an idea in a throwaway VM, is just such a nice workflow ü•∞</p>\n<p>‚Ä¶but if you have just a single system to manage, probably all of this is too\ncomplicated.</p>",
  "id": "https://michael.stapelberg.ch/posts/2025-07-13-nixos-nas-network-storage-config/"
}