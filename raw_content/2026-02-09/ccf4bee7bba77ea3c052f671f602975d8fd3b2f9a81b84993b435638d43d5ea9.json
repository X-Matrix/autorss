{
  "title": "Nested Code Fences in Markdown",
  "link": "https://susam.net/nested-code-fences.html",
  "published": "Mon, 19 Jan 2026 00:00:00 +0000",
  "summary": "<p>\n  Today, we will meet a spiky-haired nerd named Corey Dumm, who\n  normally lives within Markdown code fences.  We will get to know him\n  a bit, smile with him when his fences hold and weep quietly when\n  misfortune strikes.\n</p>\n<p>\n  One of the caveats of the Markdown universe is the wide variety of\n  Markdown implementations available.  In these parallel universes,\n  the rules of Markdown rendering differ subtly.  In this post, we\n  will focus only on the CommonMark specification.  Since GitHub\n  Flavoured Markdown (GFM) is a strict superset of CommonMark,\n  whatever we discuss here applies equally well to both CommonMark and\n  GFM.\n</p>\n<h2 id=\"contents\">Contents<a href=\"#contents\"></a></h2>\n<ul>\n  <li><a href=\"#basic-code-fences\">Basic Code Fences</a></li>\n  <li><a href=\"#fancy-code-fences\">Fancy Code Fences</a></li>\n  <li><a href=\"#basic-code-spans\">Basic Code Spans</a></li>\n  <li><a href=\"#fancy-code-spans\">Fancy Code Spans</a></li>\n  <li><a href=\"#specification\">Specification</a></li>\n</ul>\n<h2 id=\"basic-code-fences\">Basic Code Fences<a href=\"#basic-code-fences\"></a></h2>\n<p>\n  Corey had a knack for working with computers ever since he was a\n  kid.\n</p>\n<!-- Markdown #1 -->\n<pre><code>Corey at his computer:\n\n```\n(o_o)--.|[_]|\n```</code></pre>\n<p>\n  Everything was perfect in Corey's world.  The CommonMark renderer\n  would convert the Markdown above to the following HTML:\n</p>\n<!-- Rendered HTML #1 -->\n<div class=\"box\">\n<p>Corey at his computer:</p>\n<pre><code>(o_o)--.|[_]|\n</code></pre>\n</div>\n<!-- Raw HTML #1 -->\n<details>\nView HTML\n<pre><code>&lt;p&gt;Corey at his computer:&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;(o_o)--.|[_]|\n&lt;/code&gt;&lt;/pre&gt;</code></pre>\n</details>\n<p>\n  At this point, all was well.  Corey grew quickly.  Before long, he\n  had a head full of spiky hair.  Then the fences began to matter.\n</p>\n<!-- Markdown #2 -->\n<pre><code>Corey, all grown up:\n\n```\n ```\n(o_o)--.|[_]|\n```</code></pre>\n<p>\n  Let us see how this renders.  I must warn you that during the\n  Markdown-to-HTML translation, Corey loses his hair.  Some viewers\n  may find the following scene disturbing.  Viewer discretion is\n  advised.  Here is the rendered HTML:\n</p>\n<!-- Rendered HTML #2 -->\n<div class=\"box\">\n<p>Corey, all grown up:</p>\n<pre><code></code></pre>\n<p>(o_o)--.|[_]|</p>\n<pre><code></code></pre>\n</div>\n<!-- Raw HTML #2 -->\n<details>\nView HTML\n<pre><code>&lt;p&gt;Corey, all grown up:&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;\n&lt;p&gt;(o_o)--.|[_]|&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;</code></pre>\n</details>\n<p>\n  Corey's hair is gone!  What a catastrophic accident!  Corey is\n  alright, though.  He is still quite afraid of Markdown fences, but\n  otherwise well and bouncing back.  Why did this happen?  The second\n  set of triple backticks immediately ends the fenced code block\n  started by the first set of triple backticks.  As a result, Corey's\n  smiley face ends up outside the fenced code block.  The triple\n  backticks that were once Corey's hair are now woven into the fabric\n  of the surrounding HTML.  Fortunately, CommonMark offers a few ways\n  to avoid such accidents.\n</p>\n<h2 id=\"fancy-code-fences\">Fancy Code Fences<a href=\"#fancy-code-fences\"></a></h2>\n<p>\n  In CommonMark, there are two main ways to include triple backticks\n  within fenced code blocks.  First, we can use tildes as the code\n  fence:\n</p>\n<!-- Markdown #3a -->\n<pre><code>Corey, all grown up:\n\n~~~\n ```\n(o_o)--.|[_]|\n~~~</code></pre>\n<p>\n  In fact, a code fence need not consist of exactly three backticks or\n  tildes.  Any number of backticks or tildes is allowed, as long as\n  that number is at least three.  The following is therefore\n  equivalent:\n</p>\n<!-- Markdown #3b -->\n<pre><code>Corey, all grown up:\n\n~~~~~\n ```\n(o_o)--.|[_]|\n~~~~~</code></pre>\n<p>\n  And so is this:\n</p>\n<!-- Markdown #3c -->\n<pre><code>Corey, all grown up:\n\n`````\n ```\n(o_o)--.|[_]|\n`````</code></pre>\n<p>\n  All three examples render like this:\n</p>\n<!-- Rendered HTML #3 -->\n<div class=\"box\">\n<p>Corey, all grown up:</p>\n<pre><code> ```\n(o_o)--.|[_]|\n</code></pre>\n</div>\n<!-- Raw HTML #3 -->\n<details>\nView HTML\n<pre><code>&lt;p&gt;Corey, all grown up:&lt;/p&gt;\n&lt;pre&gt;&lt;code&gt; ```\n(o_o)--.|[_]|\n&lt;/code&gt;&lt;/pre&gt;</code></pre>\n</details>\n<p>\n  No hair is lost in translation.\n</p>\n<h2 id=\"basic-code-spans\">Basic Code Spans<a href=\"#basic-code-spans\"></a></h2>\n<p>\n  A similar problem arises with inline code spans.  Most Markdown\n  users know to use backticks to delimit inline code spans.  For\n  example:\n</p>\n<!-- Markdown 4 -->\n<pre><code>An old picture of Corey at his computer: `(o_o)--.|[_]|`</code></pre>\n<p>\n  This produces the following output:\n</p>\n<!-- Rendered HTML 4 -->\n<div class=\"box\">\n<p>An old picture of Corey at his computer: <code>(o_o)--.|[_]|</code></p>\n</div>\n<!-- Raw HTML 4 -->\n<details>\nView HTML\n<pre><code>&lt;p&gt;An old picture of Corey at his computer: &lt;code&gt;(o_o)--.|[_]|&lt;/code&gt;&lt;/p&gt;</code></pre>\n</details>\n<p>\n  However, what do we do when we need to put Corey's dear friend Becky\n  Trace within an inline code span?  Becky has short, straight hair\n  tucked neatly on either side of her face.  Here's a picture of her:\n</p>\n<p class=\"textcenter\">\n  <code>`(o_o)`</code>\n</p>\n<p>\n  I believe you can already see the difficulty here.  Inline code\n  spans use backticks as delimiters.  So when we put Becky within a\n  code span, the first backtick in Becky's face would terminate the\n  code span immediately and then the rest of Becky would lie outside\n  it.  CommonMark offers solutions for this kind of situation as well.\n</p>\n<h2 id=\"fancy-code-spans\">Fancy Code Spans<a href=\"#fancy-code-spans\"></a></h2>\n<p>\n  An inline code span delimiter need not consist of exactly one\n  backtick.  It can consist of any number of backticks.  So\n  <code>`foo`</code> and <code>``foo``</code> produce identical HTML.\n  There is another important but less well-known detail.  When the\n  text inside an inline code span begins and ends with spaces, one\n  space is removed from each end before rendering.  So\n  <code>`foo`</code> and <code>` foo `</code> are equivalent.\n  Therefore, when we need to put backticks within an inline code span,\n  we can start the code span using multiple backticks and a space.\n  For example:\n</p>\n<!-- Markdown #5 -->\n<pre><code>Meet Corey's friend Becky Trace: `` `(o_o)` ``</code></pre>\n<p>\n  Here is the rendered output:\n</p>\n<!-- Rendered HTML #5 -->\n<div class=\"box\">\n<p>Meet Corey's friend Becky Trace: <code>`(o_o)`</code></p>\n</div>\n<!-- Raw HTML #5 -->\n<details>\nView HTML\n<pre><code>&lt;p&gt;Meet Corey's friend Becky Trace: &lt;code&gt;`(o_o)`&lt;/code&gt;&lt;/p&gt;</code></pre>\n</details>\n<p>\n  Becky has her hair intact too.  We have avoided the mishap that once\n  caused great distress to Corey.  That, my friends, is how backticks\n  survive nesting in Markdown.\n</p>\n<h2 id=\"specification\">Specification<a href=\"#specification\"></a></h2>\n<p>\n  Before I finish this post, let us take a look at the CommonMark\n  specification to see where these details are defined.  The excerpts\n  quoted below are taken from\n  <a href=\"https://spec.commonmark.org/0.30/\">CommonMark Spec Version\n  0.30</a>, which is by now over four years old.\n</p>\n<p>\n  From section\n  <a href=\"https://spec.commonmark.org/0.30/#fenced-code-blocks\">4.5\n  Fenced Code Blocks</a>:\n</p>\n<blockquote>\n  <p>\n    A <a href=\"https://spec.commonmark.org/0.30/#code-fence\">code\n    fence</a> is a sequence of at least three consecutive backtick\n    characters (<code>`</code>) or tildes (<code>~</code>).  (Tildes\n    and backticks cannot be mixed.)\n  </p>\n</blockquote>\n<blockquote>\n  <p>\n    The content of the code block consists of all subsequent lines,\n    until a closing\n    <a href=\"https://spec.commonmark.org/0.30/#code-fence\">code fence</a>\n    of the same type as the code block began with (backticks or tildes),\n    and with at least as many backticks or tildes as the opening code\n    fence.\n  </p>\n</blockquote>\n<p>\n  From section\n  <a href=\"https://spec.commonmark.org/0.30/#code-spans\">6.1 Code\n  Spans</a>:\n</p>\n<blockquote>\n  <p>\n    A <a href=\"https://spec.commonmark.org/0.30/#backtick-string\">backtick\n    string</a> is a string of one or more backtick characters\n    (<code>`</code>) that is neither preceded nor followed by a\n    backtick.\n  </p>\n  <p>\n    A <a href=\"https://spec.commonmark.org/0.30/#code-span\">code\n    span</a> begins with a backtick string and ends with a backtick\n    string of equal length.  The contents of the code span are the\n    characters between these two backtick strings, normalized in the\n    following ways:\n  </p>\n  <ul>\n    <li>\n      First, <a href=\"https://spec.commonmark.org/0.30/#line-ending\">line endings</a>\n      are converted to <a href=\"https://spec.commonmark.org/0.30/#space\">spaces</a>.\n    </li>\n    <li>\n      If the resulting string both begins <em>and</em> ends with a\n      <a href=\"https://spec.commonmark.org/0.30/#space\">space</a>\n      character, but does not consist entirely of\n      <a href=\"https://spec.commonmark.org/0.30/#space\">space</a>\n      characters, a single\n      <a href=\"https://spec.commonmark.org/0.30/#space\">space</a>\n      character is removed from the front and back.  This allows you\n      to include code that begins or ends with backtick characters,\n      which must be separated by whitespace from the opening or\n      closing backtick strings.\n    </li>\n  </ul>\n</blockquote>\n<p>\n  I hope these little nuggets of Markdown trivialities will one day\n  prove useful in your own Markdown misfortunes.\n</p>\n<!-- ### -->\n<p>\n  <a href=\"https://susam.net/nested-code-fences.html\">Read on website</a> |\n  <a href=\"https://susam.net/tag/web.html\">#web</a> |\n  <a href=\"https://susam.net/tag/technology.html\">#technology</a>\n</p>",
  "id": "ncfim"
}