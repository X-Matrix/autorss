{
  "title": "How to annotate JITed code for perf/samply",
  "link": "https://bernsteinbear.com/blog/jit-perf-map/?utm_source=rss",
  "published": "Thu, 18 Dec 2025 00:00:00 +0000",
  "summary": "<p>Brief one today. I got asked “does YJIT/ZJIT have support for [Linux] perf?”</p>\n\n<p>The answer is yes, and it also works with <a href=\"https://github.com/mstange/samply\">samply</a> (including on macOS!),\nbecause both understand the <a href=\"https://github.com/torvalds/linux/blob/516471569089749163be24b973ea928b56ac20d9/tools/perf/Documentation/jit-interface.txt\">perf map interface</a>.</p>\n\n<p>This is the entirety of the implementation in ZJIT<sup id=\"fnref:hex\"><a class=\"footnote\" href=\"#fn:hex\" rel=\"footnote\">1</a></sup>:</p>\n\n<div class=\"language-rust highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">fn</span> <span class=\"nf\">register_with_perf</span><span class=\"p\">(</span><span class=\"n\">iseq_name</span><span class=\"p\">:</span> <span class=\"nb\">String</span><span class=\"p\">,</span> <span class=\"n\">start_ptr</span><span class=\"p\">:</span> <span class=\"nb\">usize</span><span class=\"p\">,</span> <span class=\"n\">code_size</span><span class=\"p\">:</span> <span class=\"nb\">usize</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">use</span> <span class=\"nn\">std</span><span class=\"p\">::</span><span class=\"nn\">io</span><span class=\"p\">::</span><span class=\"n\">Write</span><span class=\"p\">;</span>\n    <span class=\"k\">let</span> <span class=\"n\">perf_map</span> <span class=\"o\">=</span> <span class=\"nd\">format!</span><span class=\"p\">(</span><span class=\"s\">\"/tmp/perf-{}.map\"</span><span class=\"p\">,</span> <span class=\"nn\">std</span><span class=\"p\">::</span><span class=\"nn\">process</span><span class=\"p\">::</span><span class=\"nf\">id</span><span class=\"p\">());</span>\n    <span class=\"k\">let</span> <span class=\"nf\">Ok</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"nn\">std</span><span class=\"p\">::</span><span class=\"nn\">fs</span><span class=\"p\">::</span><span class=\"nn\">OpenOptions</span><span class=\"p\">::</span><span class=\"nf\">new</span><span class=\"p\">()</span><span class=\"nf\">.create</span><span class=\"p\">(</span><span class=\"k\">true</span><span class=\"p\">)</span><span class=\"nf\">.append</span><span class=\"p\">(</span><span class=\"k\">true</span><span class=\"p\">)</span><span class=\"nf\">.open</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">perf_map</span><span class=\"p\">)</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n        <span class=\"nd\">debug!</span><span class=\"p\">(</span><span class=\"s\">\"Failed to open perf map file: {perf_map}\"</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span><span class=\"p\">;</span>\n    <span class=\"p\">};</span>\n    <span class=\"k\">let</span> <span class=\"k\">mut</span> <span class=\"n\">file</span> <span class=\"o\">=</span> <span class=\"nn\">std</span><span class=\"p\">::</span><span class=\"nn\">io</span><span class=\"p\">::</span><span class=\"nn\">BufWriter</span><span class=\"p\">::</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">);</span>\n    <span class=\"k\">let</span> <span class=\"nf\">Ok</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"nd\">writeln!</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s\">\"{start_ptr:x} {code_size:x} zjit::{iseq_name}\"</span><span class=\"p\">)</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n        <span class=\"nd\">debug!</span><span class=\"p\">(</span><span class=\"s\">\"Failed to write {iseq_name} to perf map file: {perf_map}\"</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span><span class=\"p\">;</span>\n    <span class=\"p\">};</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>Whenever you generate a function, append a one-line entry consisting of</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>START SIZE symbolname\n</code></pre></div></div>\n\n<p>to <code class=\"language-plaintext highlighter-rouge\">/tmp/perf-{PID}.map</code>. Per the Linux docs linked above,</p>\n\n<blockquote>\n  <p>START and SIZE are hex numbers without 0x.</p>\n\n  <p>symbolname is the rest of the line, so it could contain special characters.</p>\n</blockquote>\n\n<p>You can now happily run <code class=\"language-plaintext highlighter-rouge\">perf record your_jit [...]</code> or <code class=\"language-plaintext highlighter-rouge\">samply record your_jit\n[...]</code> and have JIT frames be named in the output. We hide this behind\nthe <code class=\"language-plaintext highlighter-rouge\">--zjit-perf</code> flag to avoid file I/O overhead when we don’t need it.</p>\n\n<h2 id=\"there-is-also-the-jit-dump-interface\">There is also the JIT dump interface</h2>\n\n<p>Perf map is the older way to interact with perf: a newer, more complicated way\ninvolves <a href=\"https://theunixzoo.co.uk/blog/2025-09-14-linux-perf-jit.html\">generating a “dump” file</a> and then <code class=\"language-plaintext highlighter-rouge\">perf inject</code>ing it.</p>\n\n<!--\n\n## There is also the JIT gdb interface\n\nThis is not strictly related but I want to figure it out\n\n-->\n<div class=\"footnotes\">\n  <ol>\n    <li id=\"fn:hex\">\n      <p>We actually use <code class=\"language-plaintext highlighter-rouge\">{:#x}</code>, which I noticed today is wrong. <code class=\"language-plaintext highlighter-rouge\">{:#x}</code> leaves\nin the <code class=\"language-plaintext highlighter-rouge\">0x</code>, and it shouldn’t; instead <strong>use <code class=\"language-plaintext highlighter-rouge\">{:x}</code></strong>. <a class=\"reversefootnote\" href=\"#fnref:hex\">&#8617;</a></p>\n    </li>\n  </ol>\n</div>",
  "id": "https://bernsteinbear.com/blog/jit-perf-map/"
}