{
  "title": "Walking around the compiler",
  "link": "https://bernsteinbear.com/blog/walking-around/?utm_source=rss",
  "published": "Tue, 23 Sep 2025 00:00:00 +0000",
  "summary": "<p>Walking around outside is good for you.<sup>[<a href=\"https://en.wikipedia.org/wiki/Wikipedia:Citation_needed\"><i>citation needed</i></a>]</sup>\nA nice amble through the trees can quiet inner turbulence and make complex\nengineering problems disappear.</p>\n\n<p>Vicki Boykis wrote a post, <a href=\"https://vickiboykis.com/2025/09/09/walking-around-the-app/\">Walking around the\napp</a>, about a more\nproverbial stroll. In it, she talks about constantly using your production\napplication’s interface to make sure the whole thing is cohesively designed\nwith few rough edges.</p>\n\n<p>She also talks about walking around other parts of the <em>implementation</em> of the\napplication, fixing inconsistencies, complex machinery, and broken builds. Kind\nof like picking up someone else’s trash on your hike.</p>\n\n<p>That’s awesome and universally good advice for pretty much every software\nproject. It got me thinking about how I walk around the compiler.</p>\n\n<h2 id=\"what-does-your-output-look-like\">What does your output look like?</h2>\n\n<p>There’s a certain class of software project that transforms data—compression\nlibraries, compilers, search engines—for which there’s another layer of\n“walking around” you can do. You have the code, yes, but you also have\n<em>non-trivial output</em>.</p>\n\n<!-- TODO pick another term -->\n\n<p>By non-trivial, I mean an output that scales along some quality axis instead of\nsomething semi-regular like a JSON response. For compression, it’s size. For\ncompilers, it’s generated code.</p>\n\n<p>You probably already have some generated cases checked into your codebase as\ntests. That’s awesome. I think golden tests are fantastic for correctness and\nfor people to help understand. But this isolated understanding may not scale to\nmore complex examples.</p>\n\n<p>How <em>does</em> your compiler handle, for example, switch-case statements in loops?\nDoes it do the jump threading you expect it to? Maybe you’re sitting there idly\nwondering while you eat a cookie, but maybe that thought would only have\noccurred to you while you were scrolling through the optimizer.</p>\n\n<h3 id=\"an-example\">An example</h3>\n\n<p>Say you are <a href=\"https://cfbolz.de/\">CF Bolz-Tereick</a> and you are paging through\n<a href=\"https://pypy.org/\">PyPy</a> IR. You notice some IR that looks like:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>v0 = ...\nv1 = float_abs v0\n...\nv2 = float_abs v1\n...\nv3 = float_abs v2\n</code></pre></div></div>\n\n<p>“Huh”, you say to yourself, “surely the optimizer can reason that running\n<code class=\"language-plaintext highlighter-rouge\">float_abs</code> on the result of <code class=\"language-plaintext highlighter-rouge\">float_abs</code> is redundant!”</p>\n\n<p>But some quirk in your optimizer means that it does not. Maybe it used to work,\nor maybe it never did. But this little stroll revealed a bug with a quick fix\n(adding a new peephole optimization function):</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">optimize_FLOAT_ABS</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">op</span><span class=\"p\">):</span>\n    <span class=\"n\">v</span> <span class=\"o\">=</span> <span class=\"n\">get_box_replacement</span><span class=\"p\">(</span><span class=\"n\">op</span><span class=\"p\">.</span><span class=\"n\">getarg</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">))</span>\n    <span class=\"n\">arg_op</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">optimizer</span><span class=\"p\">.</span><span class=\"n\">as_operation</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">arg_op</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">None</span> <span class=\"ow\">and</span> <span class=\"n\">arg_op</span><span class=\"p\">.</span><span class=\"n\">getopnum</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"n\">rop</span><span class=\"p\">.</span><span class=\"n\">FLOAT_ABS</span><span class=\"p\">:</span>\n        <span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">make_equal_to</span><span class=\"p\">(</span><span class=\"n\">op</span><span class=\"p\">,</span> <span class=\"n\">v</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">emit</span><span class=\"p\">(</span><span class=\"n\">op</span><span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>Now, thankfully, your IR looks much better:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>v0 = ...\nv1 = float_abs v0\n...\n...\n</code></pre></div></div>\n\n<p>and you can check this in as a tidy test case:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">def</span> <span class=\"nf\">test_abs_abs_no</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n    <span class=\"n\">ops</span> <span class=\"o\">=</span> <span class=\"s\">\"\"\"\n    [f1]\n    f2 = float_abs(f1)\n    f3 = float_abs(f2)\n    escape_f(f3)\n    \"\"\"</span>\n    <span class=\"n\">expected</span> <span class=\"o\">=</span> <span class=\"s\">\"\"\"\n    [f1]\n    f2 = float_abs(f1)\n    escape_f(f2)\n    \"\"\"</span>\n    <span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">optimize_loop</span><span class=\"p\">(</span><span class=\"n\">ops</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>Fun fact: this was my first exposure to the PyPy project. CF walked me through\nfixing this bug<sup id=\"fnref:actual-fix\"><a class=\"footnote\" href=\"#fn:actual-fix\" rel=\"footnote\">1</a></sup> live at ECOOP 2022! I had a great time.</p>\n\n<h3 id=\"internal-state\">Internal state</h3>\n\n<p>If checking (and, later, testing) your assumptions is tricky, this may be a\nsign that your library does not expose enough of its internal state to\ndevelopers. This may present a usability impediment that prevents you from\nimmediately checking your assumptions or suspicions.</p>\n\n<p>For an excellent source of inspiration, see <a href=\"https://x.com/thingskatedid/status/1386077306381242371\">Kate’s tweets about program\ninternals</a>.</p>\n\n<p>Even if it does provide a flag like <code class=\"language-plaintext highlighter-rouge\">--zjit-dump-hir</code> to print to the console,\nmaybe this is hard to run from a phone<sup id=\"fnref:log-off\"><a class=\"footnote\" href=\"#fn:log-off\" rel=\"footnote\">2</a></sup> or a friend’s computer. For\nthat, you may want <em>friendlier tools</em>.</p>\n\n<h2 id=\"mechanical-sympathy-and-the-compiler-explorer\">Mechanical sympathy and the compiler explorer</h2>\n\n<p>The right kind of tool invites exploration.</p>\n\n<p>Matthew Godbolt built the first friendly compiler explorer tool I used, the\n<a href=\"https://godbolt.org/\">Compiler Explorer</a> (“Godbolt”). It allows inputting\nprograms into your web browser in many different languages and immediately\nseeing the compiled result. It will even execute your programs, within reason.</p>\n\n<p>This is a powerful tool:</p>\n\n<ol>\n  <li>The feedback is near-instant and live updates on key-up.</li>\n  <li>There is no fussing with the command line and file watching.</li>\n  <li>Where possible, it highlights slices of source and compiled result to\nindicate what regions produced what output.</li>\n  <li>It’s open source and you can add your own compiler.</li>\n</ol>\n\n<p>This combination lowers the barrier to check things <em>tremendously</em>.</p>\n\n<p>Now, sometimes you want the reverse: a Compiler Explorer -like thing in your\nterminal or editor so you don’t have to break flow. I unfortunately have not\nfound a comparable tool.</p>\n\n<p>In addition to the immediate effects of being able to spot-check certain inputs\nand outputs, continued use of these tools builds long-term intuition about the\nbehavior of the compiler. It builds <em>mechanical sympathy</em>.</p>\n\n<p>I haven’t written a lot about mechanical sympathy other than my grad school\n<a href=\"/assets/img/statement-of-purpose.pdf\">statement of purpose</a> (PDF) and a few\nbrief internet posts, so I will leave you with that for now.</p>\n\n<h2 id=\"every-function-is-special\">Every function is special</h2>\n\n<p>Your compiler likely compiles some applications and you can likely get access\nto the IR for the functions in that application.</p>\n\n<p>Scroll through every function’s optimized IR. If there are too many, maybe the\ntop N functions’ IRs. See what can be improved. Maybe you will see some\nunexpected patterns. Even if you don’t notice anything in May, that could shift\nby August because of compiler advancements or a cool paper that you read in the\nintervening months.</p>\n\n<p>One time I found a bizarre reference counting bug that was causing\ncopy-on-write and potential memory issues by noticing that some objects that\nshould have been marked “immortal” in the IR were actually being refcounted.\nThe bug was not in the compiler, but far away in application setup code—and\nyet it was visible in the IR.</p>\n\n<h2 id=\"love-your-tools\">Love your tools</h2>\n\n<p>My conclusion is similar to Vicki’s.</p>\n\n<p>Put some love into your tools. Your colleagues will notice. Your users will\nnotice. It might even improve your mood.</p>\n\n<h2 id=\"acknowledgements\">Acknowledgements</h2>\n\n<p>Thank you to <a href=\"https://cfbolz.de/\">CF</a> for feedback on the post.</p>\n<div class=\"footnotes\">\n  <ol>\n    <li id=\"fn:actual-fix\">\n      <p>The <a href=\"https://github.com/pypy/pypy/commit/a31689c0b5977f8a73cca87c216dc8884aa34a76\">actual\nfix</a>\nthat checks for <code class=\"language-plaintext highlighter-rouge\">float_abs(float_abs(x))</code> and rewrites to\n<code class=\"language-plaintext highlighter-rouge\">float_abs(x)</code>. <a class=\"reversefootnote\" href=\"#fnref:actual-fix\">&#8617;</a></p>\n    </li>\n    <li id=\"fn:log-off\">\n      <p>Just make sure to log off and touch grass. <a class=\"reversefootnote\" href=\"#fnref:log-off\">&#8617;</a></p>\n    </li>\n  </ol>\n</div>",
  "id": "https://bernsteinbear.com/blog/walking-around/"
}