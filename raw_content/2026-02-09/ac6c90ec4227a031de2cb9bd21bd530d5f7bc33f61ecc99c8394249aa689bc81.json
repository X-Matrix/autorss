{
  "title": "In praise of grobi for auto-configuring X11 monitors",
  "link": "https://michael.stapelberg.ch/posts/2025-05-10-grobi-x11-monitor-autoconfig/",
  "published": "2025-05-10T08:24:00+02:00",
  "summary": "<p>I have recently started using the <a href=\"https://github.com/fd0/grobi/\"><code>grobi</code> program by Alexander\nNeumann</a> again and was delighted to discover that\nit makes using my fiddly (but wonderful) <a href=\"/posts/2017-12-11-dell-up3218k/\">Dell 32-inch 8K monitor\n(UP3218K)</a> monitor much more convenient — I get\na signal more quickly than with my previous, sleep-based approach.</p>\n<p>Previously, when my PC woke up from suspend-to-RAM, there were two scenarios:</p>\n<ol>\n<li>The monitor was connected. My <a href=\"#zleep\">sleep program</a> would power on the\nmonitor (if needed), sleep a little while and then run <a href=\"https://manpages.debian.org/xrandr.1\"><code>xrandr(1)</code></a>\n to (hopefully) configure the monitor correctly.</li>\n<li>The monitor was not connected, for example because it was still connected to\nmy work PC.</li>\n</ol>\n<p>In scenario ②, or if the one-shot configuration attempt in scenario ① fails, I\nwould need to SSH in from a different computer and run <code>xrandr</code> manually so that\nthe monitor would show a signal:</p>\n<pre tabindex=\"0\"><code>% DISPLAY=:0 xrandr \\\n  --output DP-4 --mode 3840x4320 --panning 0x0+0+0 \\\n  --output DP-2 --right-of DP-4 --mode 3840x4320 --panning 0x0+3840+0\n</code></pre><h2 id=\"automatic-monitor-configuration-with-grobi\">Automatic monitor configuration with grobi</h2>\n<p>I have now completely solved this problem by creating the following\n<code>~/.config/grobi.conf</code> file:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-yaml\"><span style=\"display: flex;\"><span><span style=\"color: #062873; font-weight: bold;\">rules</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">  </span>- <span style=\"color: #062873; font-weight: bold;\">name</span>:<span style=\"color: #bbb;\"> </span>UP3218K<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span><span style=\"color: #062873; font-weight: bold;\">outputs_connected</span>:<span style=\"color: #bbb;\"> </span>[DP-2, DP-4]<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\"># DP-4 is left, DP-2 is right</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span><span style=\"color: #062873; font-weight: bold;\">configure_row</span>:<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">        </span>- DP-4@3840x4320<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">        </span>- DP-2@3840x4320<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span><span style=\"color: #60a0b0; font-style: italic;\"># atomic instructs grobi to only call xrandr once and configure all the</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span><span style=\"color: #60a0b0; font-style: italic;\"># outputs. This does not always work with all graphic cards, but is</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\"># needed to successfully configure the UP3218K monitor.</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">    </span><span style=\"color: #062873; font-weight: bold;\">atomic</span>:<span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">true</span><span style=\"color: #bbb;\">\n</span></span></span></code></pre></div><p>…and installing / enabling <code>grobi</code> (on Arch Linux) using:</p>\n<pre tabindex=\"0\"><code>% sudo pacman -S grobi\n% systemctl --user enable --now grobi\n</code></pre><p>Whenever <code>grobi</code> detects that my monitor is connected (it listens for <a href=\"https://cgit.freedesktop.org/xorg/proto/randrproto/tree/randrproto.txt\">X11\nRandR</a>\noutput change events), it will run <a href=\"https://manpages.debian.org/xrandr.1\"><code>xrandr(1)</code></a>\n to\nconfigure the monitor resolution and positioning.</p>\n<p>To check what <code>grobi</code> is seeing/doing, you can use:</p>\n<pre tabindex=\"0\"><code>% systemctl --user status grobi\n% journalctl --user -u grob\n</code></pre><p>For example, on my system, I see:</p>\n<pre tabindex=\"0\"><code>grobi: 18:31:48.823765 outputs: [HDMI-0 (primary) DP-0 DP-1 DP-2 (connected) 3840x2160+ [DEL-16711-808727372-DELL UP3218K-D2HP805I043L] DP-3 DP-4 (connected) 3840x21&gt;\ngrobi: 18:31:48.823783 new rule found: UP3218K\ngrobi: 18:31:48.823785 enable outputs: [DP-4@3840x4320 DP-2@3840x4320]\ngrobi: 18:31:48.823789 using one atomic call to xrandr\ngrobi: 18:31:48.823806 running command /usr/bin/xrandr xrandr --output DP-4 --mode 3840x4320 --output DP-2 --mode 3840x4320 --right-of DP-4\ngrobi: 18:31:49.285944 new RANDR change event received\n</code></pre><p>Notably, the instructions for getting out of a bad state (no signal) are now to\npower off the monitor and power it back on again. This will result in RandR\noutput change events, which will trigger <code>grobi</code>, which will run <code>xrandr</code>, which\nconfigures the monitor. Nice!</p>\n<h2 id=\"why-not-autorandr\">Why not autorandr?</h2>\n<p>No particular reason. I knew <code>grobi</code>.</p>\n<p>If nothing else, <code>grobi</code> is written in Go, so it’s likely to keep working\nsmoothly over the years.</p>\n<h2 id=\"does-grobi-work-on-wayland\">Does grobi work on Wayland?</h2>\n<p>Probably not. There is no mention of Wayland over on the <a href=\"https://github.com/fd0/grobi/\">grobi\nrepository</a>.</p>\n<h2 id=\"zleep\">Bonus: my Suspend-to-RAM setup</h2>\n<p>As a bonus, this section describes the other half of my monitor-related\nautomation.</p>\n<p>When I suspend my PC to RAM, I either want to wake it up manually later, for\nexample by pressing a key on the keyboard or by sending a Wake-on-LAN packet, or\nI want it to wake up automatically each morning at 6:50 — that way, daily cron\njobs have some time to run before I start using the computer.</p>\n<p>To accomplish this, I use <code>zleep</code>, a wrapper program around <a href=\"https://manpages.debian.org/rtcwake.8\"><code>rtcwake(8)</code></a>\n and <code>systemctl suspend</code> that integrates with the\nmyStrom switch smart plug to turn off power to the monitor entirely. This is\nworthwhile because the monitor draws 30W even in standby!</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-go\"><span style=\"display: flex;\"><span><span style=\"color: #007020; font-weight: bold;\">package</span><span style=\"color: #bbb;\"> </span>main<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span><span style=\"color: #007020; font-weight: bold;\">import</span><span style=\"color: #bbb;\"> </span>(<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"context\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"flag\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"fmt\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"log\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"net/http\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"net/url\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"os\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"os/exec\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #4070a0;\">\"time\"</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span>)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span><span style=\"color: #007020; font-weight: bold;\">var</span><span style=\"color: #bbb;\"> </span>(<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>resume<span style=\"color: #bbb;\"> </span>=<span style=\"color: #bbb;\"> </span>flag.<span style=\"color: #06287e;\">Bool</span>(<span style=\"color: #4070a0;\">\"resume\"</span>,<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">false</span>,<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #4070a0;\">\"run resume behavior only (turn on monitor via smart plug)\"</span>)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>noMonitor<span style=\"color: #bbb;\"> </span>=<span style=\"color: #bbb;\"> </span>flag.<span style=\"color: #06287e;\">Bool</span>(<span style=\"color: #4070a0;\">\"no_monitor\"</span>,<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">false</span>,<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #4070a0;\">\"disable turning off/on monitor\"</span>)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span>)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span><span style=\"color: #007020; font-weight: bold;\">func</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">monitorPower</span>(ctx<span style=\"color: #bbb;\"> </span>context.Context,<span style=\"color: #bbb;\"> </span>method,<span style=\"color: #bbb;\"> </span>cmnd<span style=\"color: #bbb;\"> </span><span style=\"color: #902000;\">string</span>)<span style=\"color: #bbb;\"> </span><span style=\"color: #902000;\">error</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">*</span>noMonitor<span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>log.<span style=\"color: #06287e;\">Printf</span>(<span style=\"color: #4070a0;\">\"[monitor power] skipping because -no_monitor flag is set\"</span>)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>log.<span style=\"color: #06287e;\">Printf</span>(<span style=\"color: #4070a0;\">\"[monitor power] command: %v\"</span>,<span style=\"color: #bbb;\"> </span>cmnd)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>u,<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>url.<span style=\"color: #06287e;\">Parse</span>(<span style=\"color: #4070a0;\">\"http://myStrom-Switch-A46FD0/\"</span><span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">+</span><span style=\"color: #bbb;\"> </span>cmnd)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">for</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>ctx.<span style=\"color: #06287e;\">Err</span>();<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>req,<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>http.<span style=\"color: #06287e;\">NewRequest</span>(method,<span style=\"color: #bbb;\"> </span>u.<span style=\"color: #06287e;\">String</span>(),<span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span>)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>ctx,<span style=\"color: #bbb;\"> </span>canc<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>context.<span style=\"color: #06287e;\">WithTimeout</span>(ctx,<span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">5</span><span style=\"color: #666;\">*</span>time.Second)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">defer</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">canc</span>()<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>req<span style=\"color: #bbb;\"> </span>=<span style=\"color: #bbb;\"> </span>req.<span style=\"color: #06287e;\">WithContext</span>(ctx)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>resp,<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>http.DefaultClient.<span style=\"color: #06287e;\">Do</span>(req)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span>log.<span style=\"color: #06287e;\">Print</span>(err)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span>time.<span style=\"color: #06287e;\">Sleep</span>(<span style=\"color: #40a070;\">1</span><span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">*</span><span style=\"color: #bbb;\"> </span>time.Second)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span><span style=\"color: #007020; font-weight: bold;\">continue</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>resp.StatusCode<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span>http.StatusOK<span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span>log.<span style=\"color: #06287e;\">Printf</span>(<span style=\"color: #4070a0;\">\"unexpected HTTP status code: got %v, want %v\"</span>,<span style=\"color: #bbb;\"> </span>resp.Status,<span style=\"color: #bbb;\"> </span>http.StatusOK)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span>time.<span style=\"color: #06287e;\">Sleep</span>(<span style=\"color: #40a070;\">1</span><span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">*</span><span style=\"color: #bbb;\"> </span>time.Second)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span><span style=\"color: #007020; font-weight: bold;\">continue</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>log.<span style=\"color: #06287e;\">Printf</span>(<span style=\"color: #4070a0;\">\"[monitor power] request succeeded\"</span>)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span><span style=\"color: #007020; font-weight: bold;\">func</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">nextWakeup</span>(now<span style=\"color: #bbb;\"> </span>time.Time)<span style=\"color: #bbb;\"> </span>time.Time<span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>midnight<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>time.<span style=\"color: #06287e;\">Date</span>(now.<span style=\"color: #06287e;\">Year</span>(),<span style=\"color: #bbb;\"> </span>now.<span style=\"color: #06287e;\">Month</span>(),<span style=\"color: #bbb;\"> </span>now.<span style=\"color: #06287e;\">Day</span>(),<span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">0</span>,<span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">0</span>,<span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">0</span>,<span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">0</span>,<span style=\"color: #bbb;\"> </span>time.Local)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>now.<span style=\"color: #06287e;\">Hour</span>()<span style=\"color: #bbb;\"> </span>&lt;<span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">6</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #60a0b0; font-style: italic;\">// wake up today</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span>midnight.<span style=\"color: #06287e;\">Add</span>(<span style=\"color: #40a070;\">6</span><span style=\"color: #666;\">*</span>time.Hour<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">+</span><span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">50</span><span style=\"color: #666;\">*</span>time.Minute)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\">// wake up tomorrow</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span>midnight.<span style=\"color: #06287e;\">Add</span>(<span style=\"color: #40a070;\">24</span><span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">*</span><span style=\"color: #bbb;\"> </span>time.Hour).<span style=\"color: #06287e;\">Add</span>(<span style=\"color: #40a070;\">6</span><span style=\"color: #666;\">*</span>time.Hour<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">+</span><span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">50</span><span style=\"color: #666;\">*</span>time.Minute)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span><span style=\"color: #007020; font-weight: bold;\">func</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">runResume</span>()<span style=\"color: #bbb;\"> </span><span style=\"color: #902000;\">error</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\">// Retry for up to one minute to give the network some time to come up</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>ctx,<span style=\"color: #bbb;\"> </span>canc<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>context.<span style=\"color: #06287e;\">WithTimeout</span>(context.<span style=\"color: #06287e;\">Background</span>(),<span style=\"color: #bbb;\"> </span><span style=\"color: #40a070;\">1</span><span style=\"color: #666;\">*</span>time.Minute)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">defer</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">canc</span>()<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">monitorPower</span>(ctx,<span style=\"color: #bbb;\"> </span><span style=\"color: #4070a0;\">\"GET\"</span>,<span style=\"color: #bbb;\"> </span><span style=\"color: #4070a0;\">\"relay?state=1\"</span>);<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>log.<span style=\"color: #06287e;\">Print</span>(err)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span><span style=\"color: #007020; font-weight: bold;\">func</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">zleep</span>()<span style=\"color: #bbb;\"> </span><span style=\"color: #902000;\">error</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>ctx<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>context.<span style=\"color: #06287e;\">Background</span>()<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>now<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>time.<span style=\"color: #06287e;\">Now</span>().<span style=\"color: #06287e;\">Truncate</span>(<span style=\"color: #40a070;\">1</span><span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">*</span><span style=\"color: #bbb;\"> </span>time.Second)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>wakeup<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">nextWakeup</span>(now)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>log.<span style=\"color: #06287e;\">Printf</span>(<span style=\"color: #4070a0;\">\"now   : %v\"</span>,<span style=\"color: #bbb;\"> </span>now)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>log.<span style=\"color: #06287e;\">Printf</span>(<span style=\"color: #4070a0;\">\"wakeup: %v\"</span>,<span style=\"color: #bbb;\"> </span>wakeup)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>log.<span style=\"color: #06287e;\">Printf</span>(<span style=\"color: #4070a0;\">\"wakeup: %v (timestamp)\"</span>,<span style=\"color: #bbb;\"> </span>wakeup.<span style=\"color: #06287e;\">Unix</span>())<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\">// assumes hwclock is running in UTC (see timedatectl | grep local)</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\">// Power the monitor off in 15 seconds.</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\">// mode=on is intentional: https://api.mystrom.ch/#e532f952-36ea-40fb-a180-a57b835f550e</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\">// - the switch will be turned on (already on, so this is a no-op)</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\">// - the switch will wait for 15 seconds</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #60a0b0; font-style: italic;\">// - the switch will be turned off</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">monitorPower</span>(ctx,<span style=\"color: #bbb;\"> </span><span style=\"color: #4070a0;\">\"POST\"</span>,<span style=\"color: #bbb;\"> </span><span style=\"color: #4070a0;\">\"timer?mode=on&amp;time=15\"</span>);<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>log.<span style=\"color: #06287e;\">Print</span>(err)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>sleep<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>exec.<span style=\"color: #06287e;\">Command</span>(<span style=\"color: #4070a0;\">\"sh\"</span>,<span style=\"color: #bbb;\"> </span><span style=\"color: #4070a0;\">\"-c\"</span>,<span style=\"color: #bbb;\"> </span>fmt.<span style=\"color: #06287e;\">Sprintf</span>(<span style=\"color: #4070a0;\">\"sudo rtcwake -m no --verbose --utc -t %v &amp;&amp; sudo systemctl suspend\"</span>,<span style=\"color: #bbb;\"> </span>wakeup.<span style=\"color: #06287e;\">Unix</span>()))<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>sleep.Stdout<span style=\"color: #bbb;\"> </span>=<span style=\"color: #bbb;\"> </span>os.Stdout<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>sleep.Stderr<span style=\"color: #bbb;\"> </span>=<span style=\"color: #bbb;\"> </span>os.Stderr<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>fmt.<span style=\"color: #06287e;\">Printf</span>(<span style=\"color: #4070a0;\">\"running %v\\n\"</span>,<span style=\"color: #bbb;\"> </span>sleep.Args)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span>sleep.<span style=\"color: #06287e;\">Run</span>();<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span>fmt.<span style=\"color: #06287e;\">Errorf</span>(<span style=\"color: #4070a0;\">\"%v: %v\"</span>,<span style=\"color: #bbb;\"> </span>sleep.Args,<span style=\"color: #bbb;\"> </span>err)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">return</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span><span style=\"color: #007020; font-weight: bold;\">func</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">main</span>()<span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>flag.<span style=\"color: #06287e;\">Parse</span>()<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">*</span>resume<span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">runResume</span>();<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span>log.<span style=\"color: #06287e;\">Fatal</span>(err)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">else</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span><span style=\"color: #007020; font-weight: bold;\">if</span><span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">:=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #06287e;\">zsleep</span>();<span style=\"color: #bbb;\"> </span>err<span style=\"color: #bbb;\"> </span><span style=\"color: #666;\">!=</span><span style=\"color: #bbb;\"> </span><span style=\"color: #007020; font-weight: bold;\">nil</span><span style=\"color: #bbb;\"> </span>{<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t\t</span>log.<span style=\"color: #06287e;\">Fatal</span>(err)<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\">\t</span>}<span style=\"color: #bbb;\">\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #bbb;\"></span>}<span style=\"color: #bbb;\">\n</span></span></span></code></pre></div><p>To turn power to the monitor on after resuming, I placed the following shell\nscript in <code>/lib/systemd/system-sleep/zleep.sh</code>:</p>\n<div class=\"highlight\"><pre tabindex=\"0\"><code class=\"language-bash\"><span style=\"display: flex;\"><span><span style=\"color: #007020;\">#!/bin/sh\n</span></span></span><span style=\"display: flex;\"><span><span style=\"color: #007020;\"></span>\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #007020; font-weight: bold;\">case</span> <span style=\"color: #4070a0;\">\"</span><span style=\"color: #bb60d5;\">$1</span><span style=\"color: #4070a0;\">\"</span> in\n</span></span><span style=\"display: flex;\"><span>\tpre<span style=\"color: #666;\">)</span>\t<span style=\"color: #007020;\">exit</span> <span style=\"color: #40a070;\">0</span>\n</span></span><span style=\"display: flex;\"><span>\t\t;;\n</span></span><span style=\"display: flex;\"><span>\tpost<span style=\"color: #666;\">)</span>\t/usr/local/bin/zleep -resume\n</span></span><span style=\"display: flex;\"><span>\t\t<span style=\"color: #007020;\">exit</span> <span style=\"color: #40a070;\">0</span>\n</span></span><span style=\"display: flex;\"><span>\t\t;;\n</span></span><span style=\"display: flex;\"><span> \t*<span style=\"color: #666;\">)</span>\t<span style=\"color: #007020;\">exit</span> <span style=\"color: #40a070;\">1</span>\n</span></span><span style=\"display: flex;\"><span>\t\t;;\n</span></span><span style=\"display: flex;\"><span><span style=\"color: #007020; font-weight: bold;\">esac</span>\n</span></span></code></pre></div><p>Once power is on, grobi will detect and configure the monitor.</p>\n<p>Here is the program in action:</p>\n<pre tabindex=\"0\"><code>2025/05/06 21:58:32 now   : 2025-05-06 21:58:32 +0200 CEST\n2025/05/06 21:58:32 wakeup: 2025-05-07 06:50:00 +0200 CEST\n2025/05/06 21:58:32 wakeup: 1746593400 (timestamp)\n2025/05/06 21:58:32 [monitor power] command: timer?mode=on&amp;time=15\n2025/05/06 21:58:32 [monitor power] request succeeded\nrunning [sh -c sudo rtcwake -m no --verbose --utc -t 1746593400 &amp;&amp; sudo systemctl suspend]\nUsing UTC time.\n\tdelta   = 0\n\ttzone   = 0\n\ttzname  = UTC\n\tsystime = 1746561512, (UTC) Tue May  6 19:58:32 2025\n\trtctime = 1746561512, (UTC) Tue May  6 19:58:32 2025\nalarm 1746593400, sys_time 1746561512, rtc_time 1746561512, seconds 0\nrtcwake: wakeup using /dev/rtc0 at Wed May  7 04:50:00 2025\nsuspend mode: no; leaving\n</code></pre>",
  "id": "https://michael.stapelberg.ch/posts/2025-05-10-grobi-x11-monitor-autoconfig/"
}