{
  "title": "Here be dragons: Preventing static damage, latchup, and metastability in the 386",
  "link": "http://www.righto.com/2025/08/static-latchup-metastability-386.html",
  "published": "2025-08-17T07:40:00.000-07:00",
  "summary": "<p>I've been reverse-engineering the Intel 386 processor (from 1985), and I've come across some interesting\ncircuits for the chip's input/output (I/O) pins.\nSince these pins communicate with the outside world, they face special dangers:\nstatic electricity and latchup can destroy the chip, while metastability can cause serious malfunctions.\nThese I/O circuits are completely different from the logic circuits in the 386, and I've come\nacross a previously-undescribed flip-flop circuit, so I'm\nventuring into uncharted territory.\nIn this article, I take a close look at how the I/O circuitry protects the 386 from\nthe \"dragons\" that can destroy it.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/die-pads.jpg\"><img alt=\"The 386 die, zooming in on some of the bond pad circuits. The colors change due to the effects of different microscope lenses. Click this image (or any other) for a larger version.\" class=\"hilite\" height=\"533\" src=\"https://static.righto.com/images/386-iodrivers/die-pads-w500.jpg\" title=\"The 386 die, zooming in on some of the bond pad circuits. The colors change due to the effects of different microscope lenses. Click this image (or any other) for a larger version.\" width=\"500\" /></a><div class=\"cite\">The 386 die, zooming in on some of the bond pad circuits. The colors change due to the effects of different microscope lenses. Click this image (or any other) for a larger version.</div></p>\n<p>The photo above shows the die of the 386 under a microscope.\nThe dark, complex patterns arranged in rectangular regions arise from the two layers of metal that connect the circuits on the 386 chip.\nNot visible are the transistors, formed from silicon and polysilicon and hidden beneath the metal.\nAround the perimeter of this fingernail-sized silicon die, 141 square bond pads provide the connections between\nthe chip and the outside world; tiny gold bond wires connect the bond pads to the package.\nNext to each I/O pad, specialized circuitry provides the electrical interface between the\nchip and the external components while protecting the chip.\nI've zoomed in on three groups of these bond pads along with the associated I/O circuits.\nThe circuits at the top (for data pins) and the left (for address pins) are completely different from the\ncontrol pin circuits at the bottom, showing how the\ncircuitry varies with the pin's function.</p>\n<h2>Static electricity</h2>\n<p>The first dragon that threatens the 386 is static electricity, able to burn a hole in the chip.\nMOS transistors are constructed with a thin insulating oxide layer\nunderneath the transistor's gate.\nIn the 386, this fragile, glass-like oxide layer is just 250 nm thick, the thickness of a virus.\nStatic electricity, even a small amount, can blow a hole through this oxide layer and\ndestroy the chip.\nIf you've ever walked across a carpet and felt a spark when you touch a doorknob, you've generated at least 3000 volts\nof chip-destroying static electricity. <!-- 500 volts according to https://www.intel.com/content/www/us/en/docs/programmable/683251/current/esd-performance.html -->\nIntel recommends an anti-static mat and a grounding wrist strap when installing a processor to\navoid the danger of static electricity, also known as Electrostatic Discharge or ESD.<span id=\"fnref:esd\"><a class=\"ref\" href=\"#fn:esd\">1</a></span></p>\n<p>To reduce the risk of ESD damage, chips have protection diodes and other components in their I/O circuitry.\nThe schematic below shows the circuit for a typical 386 input.\nThe goal is to prevent static discharge from reaching the inverter, where it could destroy the inverter's transistors.\nThe diodes next to the pad provide the first layer of protection; they redirect excess voltage to the +5 rail or ground.\nNext, the resistor reduces the current that can reach the inverter.\nThe third diode provides a final layer of protection.\n(One unusual feature of this input&mdash;unrelated to ESD&mdash;is that the input has a pull-up, which is implemented with a transistor that acts like a 20k&Omega; resistor.<span id=\"fnref:bs16\"><a class=\"ref\" href=\"#fn:bs16\">2</a></span>)</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/bs16-schematic.jpg\"><img alt=\"Schematic for the BS16# pad circuit. The BS16# signal indicates to the 386 if the external bus is 16 bits or 32 bits.\" class=\"hilite\" height=\"129\" src=\"https://static.righto.com/images/386-iodrivers/bs16-schematic-w550.jpg\" title=\"Schematic for the BS16# pad circuit. The BS16# signal indicates to the 386 if the external bus is 16 bits or 32 bits.\" width=\"550\" /></a><div class=\"cite\">Schematic for the <code>BS16#</code> pad circuit. The <code>BS16#</code> signal indicates to the 386 if the external bus is 16 bits or 32 bits.</div></p>\n<p>The image below shows how this circuit appears on the die.\nFor this photo, I dissolved the metal layers with acids, stripping the die down to the silicon to make the transistors visible.\nThe diodes and pull-up resistor are implemented with transistors.<span id=\"fnref:ggnmos\"><a class=\"ref\" href=\"#fn:ggnmos\">3</a></span>\nLarge grids of transistors form the pad-side diodes, while the third diode is above.\nThe current-limiting protection resistor is implemented with polysilicon, which provides higher resistance than metal wiring.\nThe capacitor is implemented with a plate of polysilicon over silicon, separated by a thin oxide layer.\nAs you can see, the protection circuitry occupies much more area than the inverters that process the signal.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/bs16-die.jpg\"><img alt=\"The circuit for BS16# on the die. The green areas are where the oxide layer was incompletely removed.\" class=\"hilite\" height=\"332\" src=\"https://static.righto.com/images/386-iodrivers/bs16-die-w500.jpg\" title=\"The circuit for BS16# on the die. The green areas are where the oxide layer was incompletely removed.\" width=\"500\" /></a><div class=\"cite\">The circuit for BS16# on the die. The green areas are where the oxide layer was incompletely removed.</div></p>\n<h2>Latchup</h2>\n<p>The transistors in the 386 are created by doping silicon with impurities to change its properties, creating regions of\n\"N-type\" and \"P-type\" silicon.\nThe 386 chip, like most processors, is built from CMOS technology, so it uses two types of transistors: NMOS and PMOS.\nThe 386 starts from a wafer of N-type silicon and\nPMOS transistors are formed by doping tiny regions to form P-type silicon embedded in the underlying N-type silicon.\nNMOS transistors are the opposite, with N-type silicon embedded in P-type silicon.\nTo hold the NMOS transistors, \"wells\" of P-type silicon are formed, as shown in the cross-section diagram below.\nThus, the 386 chip contains complex patterns of P-type and N-type silicon that form its 285,000 transistors.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/latchup-cross-section.jpg\"><img alt=\"The structure of NMOS and PMOS transistors in the 386 forms parasitic NPN and PNP transistors. This diagram is the opposite of other latchup diagrams because the 386 uses N substrate, the opposite of modern chips with P substrate.\" class=\"hilite\" height=\"244\" src=\"https://static.righto.com/images/386-iodrivers/latchup-cross-section-w500.jpg\" title=\"The structure of NMOS and PMOS transistors in the 386 forms parasitic NPN and PNP transistors. This diagram is the opposite of other latchup diagrams because the 386 uses N substrate, the opposite of modern chips with P substrate.\" width=\"500\" /></a><div class=\"cite\">The structure of NMOS and PMOS transistors in the 386 forms parasitic NPN and PNP transistors. This diagram is the opposite of other latchup diagrams because the 386 uses N substrate, the opposite of modern chips with P substrate.</div></p>\n<p>But something dangerous lurks below the surface, the fire-breathing dragon of latchup waiting to burn up the chip.\nThe problem is that these regions of N-type and P-type silicon form unwanted, \"parasitic\" transistors underneath\nthe desired transistors.\nIn normal circumstances, these parasitic NPN and PNP transistors are inactive and can be ignored.\nBut if a current flows beneath the surface, through the silicon substrate,\nit can turn on a parasitic transistor and awaken the dreaded latchup.<span id=\"fnref:substrate\"><a class=\"ref\" href=\"#fn:substrate\">4</a></span>\nThe parasitic transistors form a feedback loop, so if one transistor starts to turn on,\nit turns on the other transistor, and so forth, until both transistors are fully on, a state called latchup.<span id=\"fnref:scr\"><a class=\"ref\" href=\"#fn:scr\">5</a></span>\nMoreover, the feedback loop will maintain latchup until the chip's power is removed.<span id=\"fnref:power-cycle\"><a class=\"ref\" href=\"#fn:power-cycle\">6</a></span>\nDuring latchup, the chip's power and ground are shorted through the parasitic transistors, causing high current flow that\ncan destroy the chip by overheating it or even melting bond wires.</p>\n<p>Latchup can be triggered in many ways, from power supply overvoltage to radiation, but\na chip's I/O pins are the primary risk because signals from the outside world are unpredictable.\nFor instance, suppose a floppy drive is connected to the 386 and the drive sends a signal with a voltage higher than\nthe 386's 5-volt supply.\n(This could happen due to a voltage surge in the drive, reflection in a signal line, or even connecting a cable.)\nCurrent will flow through the 386's protection diodes, the diodes that were described in the previous section.<span id=\"fnref:latchup-recommendations\"><a class=\"ref\" href=\"#fn:latchup-recommendations\">7</a></span>\nIf this current flows through the chip's silicon substrate, it can trigger latchup and destroy the processor.</p>\n<p>Because of this danger, the 386's I/O pads are designed to prevent latchup.\nOne solution is to block the unwanted currents through the substrate, essentially putting fences around the transistors\nto keep malicious currents from escaping into the substrate.\nIn the 386, this fence consists of \"guard rings\" around the I/O transistors and diodes.\nThese rings prevent latchup by blocking unwanted current flow and safely redirecting it to power or ground.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/wr-diagram.jpg\"><img alt=\"The circuitry for the W/R# output pad. (The W/R# signal tells the computer's memory and I/O if the 386 is performing a write operation or a read operation.) I removed the metal and polysilicon to show the underlying silicon.\" class=\"hilite\" height=\"394\" src=\"https://static.righto.com/images/386-iodrivers/wr-diagram-w500.jpg\" title=\"The circuitry for the W/R# output pad. (The W/R# signal tells the computer's memory and I/O if the 386 is performing a write operation or a read operation.) I removed the metal and polysilicon to show the underlying silicon.\" width=\"500\" /></a><div class=\"cite\">The circuitry for the W/R# output pad. (The W/R# signal tells the computer's memory and I/O if the 386 is performing a write operation or a read operation.) I removed the metal and polysilicon to show the underlying silicon.</div></p>\n<p>The diagram above shows the double guard rings for a typical I/O pad.<span id=\"fnref:wr-schematic\"><a class=\"ref\" href=\"#fn:wr-schematic\">8</a></span>\nSeparate guard rings protect the NMOS transistors and the PMOS transistors.\nThe NMOS transistors have an inner guard ring of P-type silicon connected to ground (blue) and an outer guard ring of N-type silicon\nconnected to +5 (red). The rings are reversed for the PMOS transistors.\nThe guard rings take up significant space on the die, but this space isn't wasted since the rings protect the chip from latchup.</p>\n<h2>Metastability</h2>\n<p>The final dragon is metastability: it (probably) won't destroy the chip, but it can cause\nserious malfunctions.<span id=\"fnref:spacecraft\"><a class=\"ref\" href=\"#fn:spacecraft\">9</a></span>\nMetastability is a peculiar problem where a digital signal can take an unbounded amount of time to settle into\na zero or a one.\nIn other words, the circuit temporarily refuses to act digitally and shows its underlying analog nature.<span id=\"fnref:vonada\"><a class=\"ref\" href=\"#fn:vonada\">10</a></span>\nMetastability was controversial in the 1960s and the 1970s, with many electrical engineers not believing it existed or\nconsidering it irrelevant.\nNowadays, metastability is well understood, with special circuits to prevent it, but metastability can never\nbe completely eliminated.</p>\n<p>In a processor, everything is synchronized to its clock.\nWhile a modern processor has a clock speed of several gigahertz, the 386's clock ran at 12 to 33 megahertz.\nInside the processor, signals are carefully organized to change according to the clock&mdash;that's why your\ncomputer runs faster with a higher clock speed.\nThe problem is that external signals may be independent of the CPU's clock.\nFor instance, a disk drive could send an interrupt to the computer when data is ready, which depends on the timing\nof the spinning disk.\nIf this interrupt arrives at just the wrong time, it can trigger metastability.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/metastability-1974.jpg\"><img alt=\"A metastable signal settling to a high or low signal after an indefinite time. This image was used to promote a class on metastability in 1974. From My Work on All Things Metastable by Thomas Chaney.\" class=\"hilite\" height=\"258\" src=\"https://static.righto.com/images/386-iodrivers/metastability-1974-w350.jpg\" title=\"A metastable signal settling to a high or low signal after an indefinite time. This image was used to promote a class on metastability in 1974. From My Work on All Things Metastable by Thomas Chaney.\" width=\"350\" /></a><div class=\"cite\">A metastable signal settling to a high or low signal after an indefinite time. This image was used to promote a class on metastability in 1974. From <a href=\"https://www.arl.wustl.edu/~jon.turner/cse/260/glitchChaney.pdf\">My Work on All Things Metastable</a> by Thomas Chaney.</div></p>\n<p>In more detail, processors use flip-flops to hold signals under the control of the clock.\nAn \"edge-triggered\" flip-flop grabs its\ninput at the moment the clock goes high (the \"rising edge\") and holds this value until the next clock cycle.\nEverything is fine if the value is stable when the clock changes:\nif the input signal switches from low to high before the clock edge, the flip-flop will hold this high value.\nAnd if the input signal switches from low to high <em>after</em> the clock edge, the flip-flop will hold the low value, since\nthe input was low at the clock edge.\nBut what happens if the input changes from low to high at the exact time that the clock switches?\nUsually, the flip-flop will pick either low or high.\nBut very rarely, maybe a few times out of a billion, the flip-flop will hesitate in between, neither low nor high.\nThe flip-flop may take a few nanoseconds before it \"decides\" on a low or high value, and the value will be intermediate\nuntil then.</p>\n<p>The photo above illustrates a metastable signal, spending an unpredictable time between zero and one before settling\non a value.\nThe situation is similar to a ball balanced on top of a hill, a point of unstable equilibrium.<span id=\"fnref:physics\"><a class=\"ref\" href=\"#fn:physics\">11</a></span>\nThe smallest perturbation will knock the ball down one of the two stable positions at the bottom of the hill, but you\ndon't know which way it will go or how long it will take.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/hill.jpg\"><img alt=\"A metaphorical view of metastability as a ball on a hill, able to roll down either side.\" class=\"hilite\" height=\"156\" src=\"https://static.righto.com/images/386-iodrivers/hill-w300.jpg\" title=\"A metaphorical view of metastability as a ball on a hill, able to roll down either side.\" width=\"300\" /></a><div class=\"cite\">A metaphorical view of metastability as a ball on a hill, able to roll down either side.</div></p>\n<p>Metastability is serious because if a digital signal has a value that is neither 0 nor 1 then downstream\ncircuitry may get confused.\nFor instance, if part of the processor thinks that it received an interrupt and other parts of the processor think\nthat no interrupt happened, chaos will reign as the processor takes contradictory actions.\nMoreover, waiting a few nanoseconds isn't a cure because the duration of metastability can be arbitrarily long.\nWaiting helps, since the chance of metastability decreases exponentially with time, but there is no guarantee.<span id=\"fnref:metastability\"><a class=\"ref\" href=\"#fn:metastability\">12</a></span></p>\n<p>The obvious solution is to never change an input exactly when the clock changes.\nThe processor is designed so that internal signals are stable when the clock changes, avoiding metastability.\nSpecifically, the designer of a flip-flop specifies the <em>setup</em> time&mdash;how long the signal must be stable before the clock edge&mdash;and the <em>hold</em> time&mdash;how long the signal must be stable after the clock edge.\nAs long as the input satisfies these conditions, typically a few picoseconds long,\nthe flip-flop will function without metastability.</p>\n<p>Unfortunately, the setup and hold times can't be guaranteed when the processor receives an external signal that\nisn't synchronized to its clock, known as an asynchronous signal.\nFor instance, a processor receives interrupt signals when an I/O device has data, but the timing is unpredictable\nbecause it depends on \nmechanical factors such as a keypress or a spinning floppy disk.\nMost of the time, everything will work fine, but what about the one-in-a-billion case where the timing of the\nsignal is unlucky?\n(Since modern processors run at multi-gigahertz, one-in-a-billion events are not rare; they\ncan happen multiple times per second.)</p>\n<p>One solution is a circuit called a synchronizer that takes an asynchronous signal and\nsynchronizes it to the clock.\nA synchronizer can be implemented with two flip-flops in series:\neven if the first flip-flop has a metastable output, chances are that it will resolve to 0 or 1 before the second flip-flop\nstores the value.\nEach flip-flop provides an exponential reduction in the chance of metastability, so using two flip-flops\ndrastically reduces the risk.\nIn other words, the circuit will still fail occasionally, but if the mean time between failures (MTBF) is long enough\n(say, decades instead of seconds), then the risk is acceptable.</p>\n<!--\nThe problem of metastability arises often in FPGA design, whenever a signal crosses a clock domain.\nThat is, if two parts of the FPGA use different clocks, the risk of metastability arises whenever\na signal is generated with one clock and used with another clock.\nThe standard FPGA solution is a synchronizer register chain with two flip-flops or more,\nsuch as this [Intel recommendation](https://www.intel.com/content/www/us/en/docs/programmable/683082/21-3/synchronization-register-chains.html)\n-->\n\n<p><a href=\"https://static.righto.com/images/386-iodrivers/busy-schematic.jpg\"><img alt=\"The schematic for the BUSY# pin, showing the flip-flops that synchronize the input signal.\" class=\"hilite\" height=\"190\" src=\"https://static.righto.com/images/386-iodrivers/busy-schematic-w400.jpg\" title=\"The schematic for the BUSY# pin, showing the flip-flops that synchronize the input signal.\" width=\"400\" /></a><div class=\"cite\">The schematic for the BUSY# pin, showing the flip-flops that synchronize the input signal.</div></p>\n<p>The schematic above shows how the 386 uses two flip-flops to minimize metastability.\nThe first flip-flop is a special flip-flop that is based on a sense amplifier.\nIt is much more complicated than a regular flip-flop, but it responds faster, reducing the\nchance of metastability.\nIt is built from two of the sense-amplifier latches below, which I haven't seen described anywhere.\nIn a DRAM memory chip, a sense amplifier takes a weak signal from a memory cell and rapidly amplifies it into a\nsolid 0 or 1.\nIn this flip-flop, the sense amplifier takes a potentially ambiguous signal and rapidly amplifies it into a 0 or 1.\nBy amplifying the signal quickly, the flip-flop reduces metastability.\n(See the footnote for details.<span id=\"fnref:sense-latch\"><a class=\"ref\" href=\"#fn:sense-latch\">14</a></span>)</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/sense-latch.jpg\"><img alt=\"The sense amplifier latch circuit.\" class=\"hilite\" height=\"436\" src=\"https://static.righto.com/images/386-iodrivers/sense-latch-w350.jpg\" title=\"The sense amplifier latch circuit.\" width=\"350\" /></a><div class=\"cite\">The sense amplifier latch circuit.</div></p>\n<p>The die photo below shows how this circuitry looks on the die. Each flip-flop is built from two latches;\nnote that the sense-amp latches are larger than the standard latches.\nAs before, the pad has protection diodes inside guard rings. For some reason, however,\nthese diodes have a different structure from the transistor-based diodes described earlier.\nThe 386 has five inputs that use this circuitry to protect against metastability.<span id=\"fnref:metastable-pins\"><a class=\"ref\" href=\"#fn:metastable-pins\">13</a></span>\nThese inputs are all located together at the bottom of the die&mdash;it probably makes the layout more compact when\nneighboring pad circuits are all the same size.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/busy-die.jpg\"><img alt=\"The circuitry for the BUSY# pin, showing the special sense-amplifier latches that reduce metastability.\" class=\"hilite\" height=\"454\" src=\"https://static.righto.com/images/386-iodrivers/busy-die-w500.jpg\" title=\"The circuitry for the BUSY# pin, showing the special sense-amplifier latches that reduce metastability.\" width=\"500\" /></a><div class=\"cite\">The circuitry for the BUSY# pin, showing the special sense-amplifier latches that reduce metastability.</div></p>\n<p>In summary, the 386's I/O circuits are interesting because they are completely different from the chip's regular logic circuitry.\nIn these circuits, the border between digital and analog breaks down; these circuits handle binary signals, but\nanalog issues dominate the design.\nMoreover, hidden parasitic transistors play key roles; what you don't see can be more important than what you see.\nThese circuits defend against three dangerous \"dragons\": static electricity, latchup, and metastability.\nIntel succeeded in warding off these dragons and the 386 was a success.</p>\n<p>For more on the 386 and other chips, follow me on\nMastodon (<a href=\"https://oldbytes.space/@kenshirriff\">@kenshirriff@oldbytes.space</a>),\nBluesky (<a href=\"https://bsky.app/profile/righto.com\">@righto.com</a>),\nor <a href=\"http://www.righto.com/feeds/posts/default\">RSS</a>.  (I've given up on Twitter.)\nIf you want to read more about 386 input circuits, I wrote about the clock pin <a href=\"https://www.righto.com/2023/11/intel-386-clock-circuit.html\">here</a></p>\n<h2>Notes and references</h2>\n<div class=\"footnote\">\n<ol>\n<li id=\"fn:esd\">\n<p>Anti-static precautions are specified in Intel's <a href=\"https://www.intel.com/content/www/us/en/support/articles/000058166/processors.html\">processor installation instructions</a>.\nAlso see Intel's <a href=\"https://www.intel.com/content/dam/www/public/us/en/documents/guides/ch3-esd-eos-guide.pdf\">Electrostatic Discharge and Electrical Overstress Guide</a>.\nI couldn't find ESD ratings for the 386, but a <a href=\"https://www.intel.com/content/www/us/en/docs/programmable/683251/current/esd-performance.html\">modern Intel chip</a> is tested to withstand 500 volts or 2000 volts,\ndepending on the test procedure.&#160;<a class=\"footnote-backref\" href=\"#fnref:esd\" title=\"Jump back to footnote 1 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:bs16\">\n<p>The BS16# pin is slightly unusual because it has an internal pull-up resistor.\nIf you look at the <a href=\"https://datasheets.chipdb.org/Intel/x86/386/datashts/23163011.pdf\">datasheet</a> (9.2.3 and Table 9-3 footnotes),\na few input pins (ERROR#, BUSY#, and BS16#) have internal pull-up resistors of 20 k&Omega;, while the \nPEREQ input pin has an internal pull-down resistor of 20 k&Omega;.&#160;<a class=\"footnote-backref\" href=\"#fnref:bs16\" title=\"Jump back to footnote 2 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:ggnmos\">\n<p>The protection diode is probably a <a href=\"https://en.wikipedia.org/wiki/GgNMOS\">grounded-gate NMOS</a> (ggNMOS), an NMOS transistor with\nthe gate, source, and body (but not the drain) tied to ground. This forms a parasitic NPN transistor under the MOSFET that\ndissipates the ESD.\n(I think that the PMOS protection is the same, except the gate is pulled high, not grounded.)\nFor output pins, the output driver MOSFETs have parasitic transistors that make the output driver\n\"self-protected\".\nOne consequence is that the input pads and the output pads look similar (both have large MOS transistors),\nunlike other chips where the presence of large transistors indicates an output.\n(Even so, 386 outputs and inputs can be distinguished because outputs have large inverters inside the guard rings to drive the MOSFETs, while inputs do not.)\nAlso see <a href=\"https://ieeexplore.ieee.org/document/9646371\">Practical ESD Protection Design</a>.&#160;<a class=\"footnote-backref\" href=\"#fnref:ggnmos\" title=\"Jump back to footnote 3 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:substrate\">\n<p>The 386 uses P-wells in an N-doped substrate. The substrate is heavily doped with antimony, with a lightly doped N\nepitaxial layer on top. This doping helped provide immunity to latchup. (See \"High performance technology, circuits and packaging for the 80386\", ICCD 1986.)\nFor the most part, modern chips use the opposite: N-wells with a P-doped substrate.\nWhy the substrate change?</p>\n<p>In the earlier days of CMOS, P-well was standard due to the available doping technology,\nsee <a href=\"https://doi.org/10.1109/IEDM.1983.190465\">N-well and P-well performance comparison</a>.\nDuring the 1980s, there was controversy over which was better: P-well or N-well:\n\"It is commonly agreed that P-well technology has a proven reliability record,\nreduced alpha-particle sensitivity, closer matched p- and n- channel devices, and\nhigh gain NPN structures. N-well proponents acknowledge better compatibility and\nperformance with NMOS processing and designs, good substrate quality, availability,\nand cost, lower junction capacitance, and reduced body effects.\"\n(See <a href=\"https://ucalgary.scholaris.ca/server/api/core/bitstreams/fd39e68c-1c60-4a26-8ac3-7f21a32a5108/content\">Design of a CMOS Standard Cell Library</a>.)</p>\n<p>As wafer sizes increased in the 1990s, technology shifted to P-doped substrates because it is difficult to make large N-doped wafers due to\nthe characteristics of the dopants (<a href=\"https://physics.stackexchange.com/a/162969/141705\">link</a>).\nSome chips optimize transistor characteristics by using both types of wells, called a twin-well process.\nFor instance, the Pentium used P-doped wafers and implanted both N and P wells.\n(See\n<a href=\"https://www.intel.com/content/dam/www/public/us/en/documents/research/1998-vol02-iss-3-intel-technology-journal.pdf\">Intel's 0.25 micron, 2.0 volts logic process technology</a>.)&#160;<a class=\"footnote-backref\" href=\"#fnref:substrate\" title=\"Jump back to footnote 4 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:scr\">\n<p>You can also view the parasitic transistors as forming an SCR (Silicon Controlled Rectifier), a four-layer\nsemiconductor device.\nSCRs were popular in the 1970s because they could handle higher currents and voltages than transistors.\nBut as high-power transistors were developed, SCRs fell out of favor.\nIn particular, once an SCR is turned on, it stays on until power is removed or reversed; this makes SCRs harder to\nuse than transistors.\n(This is the same characteristic that makes latchup so dangerous.)&#160;<a class=\"footnote-backref\" href=\"#fnref:scr\" title=\"Jump back to footnote 5 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:power-cycle\">\n<p>Satellites and nuclear missiles have a high risk of latchup due to radiation.\nSince radiation-induced latchup cannot always be prevented, \none technique for dealing with latchup is to detect the excessive current from latchup and then power-cycle the chip.\nFor instance, you can buy a <a href=\"https://www.st.com/en/space-products/rhrpmicl1a.html\">radiation-hardened current limiter chip</a> that will detect excessive current due to latchup and temporarily remove power;\nthis chip sells for the remarkable price of <a href=\"https://www.digikey.com/en/products/detail/stmicroelectronics/RH-PMICL1AK1/22106445\">$1780</a>.</p>\n<p>For more on latchup, see the Texas Instruments <a href=\"https://www.ti.com/lit/wp/scaa124/scaa124.pdf\">Latch-Up</a> white\npaper, as well as <a href=\"https://www.ti.com/lit/an/slya014a/slya014a.pdf\">Latch-Up, ESD, and Other Phenomena</a>.&#160;<a class=\"footnote-backref\" href=\"#fnref:power-cycle\" title=\"Jump back to footnote 6 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:latchup-recommendations\">\n<p>The <a href=\"http://www.bitsavers.org/components/intel/80386/231732-001_80386_Hardware_Reference_Manual_1986.pdf#page=189\">80386 Hardware Reference Manual</a>\ndiscusses how a computer designer can prevent latchup in the 386.\nThe designer is assured that Intel's \"CHMOS III\" process prevents latchup under normal operating conditions.\nHowever, exceeding the voltage limits on I/O pins can cause current surges and latchup.\nIntel provides three guidelines: observe the maximum ratings for input voltages, never apply power to a 386 pin before the chip is powered up, and terminate I/O signals properly to avoid overshoot and undershoot.&#160;<a class=\"footnote-backref\" href=\"#fnref:latchup-recommendations\" title=\"Jump back to footnote 7 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:wr-schematic\">\n<p>The circuit for the WR# pin is similar to many other output pins.\nThe basic idea is that a large PMOS transistor pulls the output high, while a large NMOS transistor pulls the\noutput low.\nIf the <code>enable</code> input is low, both transistors are turned off and the output floats. (This allows other devices\nto take over the bus in the HOLD state.)</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/wr-schematic.jpg\"><img alt=\"Schematic for the WR# pin driver.\" class=\"hilite\" height=\"167\" src=\"https://static.righto.com/images/386-iodrivers/wr-schematic-w400.jpg\" title=\"Schematic for the WR# pin driver.\" width=\"400\" /></a><div class=\"cite\">Schematic for the WR# pin driver.</div></p>\n<p>The inverters that control the drive transistors have an unusual layout.\nThese inverters are inside the guard rings, meaning that the inverters are split apart, with the NMOS\ntransistors in one ring and PMOS transistors in the other.\nThe extra wiring adds capacitance to the output which probably makes the inverters slightly slower.</p>\n<p>These inverters have a special design: one inverter is faster to go high than to go low,\nwhile the other inverter is the opposite.\nThe motivation is that if both drive transistors are on at the same time,\na large current will flow through the transistors from power to\nground, producing an unwanted current spike (and potentially latchup).\nTo avoid this, the inverters are designed to turn one drive transistor off faster than turning the other one on.\nSpecifically, the high-side inverter has an extra transistor to quickly pull its output high, while the low-side inverter has an\nextra transistor to pull the output low.\nMoreover, the inverter's extra transistor is connected directly to the drive transistors, while the\ninverter's main output connects through a longer polysilicon path with more resistance, providing an RC delay.\nI found this layout very puzzling until I realized that the designers were carefully controlling the\nturn-on and turn-off speeds of these inverters.&#160;<a class=\"footnote-backref\" href=\"#fnref:wr-schematic\" title=\"Jump back to footnote 8 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:spacecraft\">\n<p>In <a href=\"https://www.cs.unc.edu/~montek/teaching/Comp790-Fall11/Home/Home_files/ginosar-tutorial-dt-2011.pdf\">Metastability and\nSynchronizers: A Tutorial</a>,\nthere's a story of a spacecraft power supply being destroyed by metastability. Supposedly, metastability caused\nthe logic to turn on too many units, overloading and destroying the power supply.\nI suspect that this is a fictional cautionary tale, rather than an actual incident.</p>\n<p>For more on metastability, see <a href=\"https://classes.engineering.wustl.edu/cse464/images/6/60/Metastability.pdf\">this presentation</a> and <a href=\"https://www.arl.wustl.edu/~jon.turner/cse/260/glitchChaney.pdf\">this writeup</a> by Tom Chaney, one of the\nearly investigators of metastability.&#160;<a class=\"footnote-backref\" href=\"#fnref:spacecraft\" title=\"Jump back to footnote 9 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:vonada\">\n<p>One of Vonada's Engineering Maxims is \"Digital circuits are made from analog parts.\"\nAnother maxim is \"Synchronizing circuits may take forever to make a decision.\"\nThese maxims and a dozen others are from Don Vonada in DEC's 1978 book <a href=\"http://www.bitsavers.org/pdf/dec/_Books/Bell-ComputerEngineering.pdf#page=47\">Computer Engineering</a>.&#160;<a class=\"footnote-backref\" href=\"#fnref:vonada\" title=\"Jump back to footnote 10 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:physics\">\n<p>Curiously, the definition of metastability in electronics doesn't match the definition in <a href=\"https://archive.org/details/penguindictionar00illi/page/297/mode/1up?q=metastable\">physics</a> and <a href=\"https://archive.org/details/penguindictionar0000unse_k5h5/page/161/mode/1up?q=metastable\">chemistry</a>.\nIn electronics, a metastable state is an unstable equilibrium.\nIn physics and chemistry, however, a metastable state is a stable state, just not the most stable ground state, so a\nmoderate perturbation will knock it from the metastable state to the ground state.\n(In the hill analogy, it's as if the ball is caught in a small basin partway down the hill.)&#160;<a class=\"footnote-backref\" href=\"#fnref:physics\" title=\"Jump back to footnote 11 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:metastability\">\n<p>In case you're wondering what's going on with metastability at the circuit level, I'll give a brief explanation.\nA typical flip-flop is based on a latch circuit like the one below, which consists of two inverters and an\nelectronic switch controlled by the clock.\nWhen the clock goes high, the inverters are configured into a loop, latching the prior input value.\nIf the input was high, the output from the\nfirst inverter is low and the output from the second inverter is high. The loop feeds this output back into the\nfirst inverter, so the circuit is stable. Likewise, the circuit can be stable with a low input.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/latch.jpg\"><img alt=\"A latch circuit.\" class=\"hilite\" height=\"109\" src=\"https://static.righto.com/images/386-iodrivers/latch-w300.jpg\" title=\"A latch circuit.\" width=\"300\" /></a><div class=\"cite\">A latch circuit.</div></p>\n<p>But what happens if the clock flips the switch as the input is changing, so the input to the first inverter is\nsomewhere between zero and one?\nWe need to consider that an inverter is really an analog device, not a binary device.\nYou can describe it by a \"voltage transfer curve\" (purple line)\nthat specifies the output voltage for a particular input voltage. For example, if you put in a low input, you\nget a high output, and vice versa.\nBut there is an equilibrium point where the output voltage is the same as the input voltage.\nThis is where metastability happens.</p>\n<p><a href=\"https://static.righto.com/images/386-iodrivers/metastability.jpg\"><img alt=\"The voltage transfer curve for a hypothetical inverter.\" class=\"hilite\" height=\"266\" src=\"https://static.righto.com/images/386-iodrivers/metastability-w400.jpg\" title=\"The voltage transfer curve for a hypothetical inverter.\" width=\"400\" /></a><div class=\"cite\">The voltage transfer curve for a hypothetical inverter.</div></p>\n<p>Suppose the input voltage to the inverter is the equilibrium voltage.\nIt's not going to be <em>precisely</em> the equilibrium voltage (because of noise if nothing else), so suppose,\nfor example, that it is 1µV above equilibrium.\nNote that the transfer curve is very steep around equilibrium, say a slope of 100, so it will greatly amplify the\nsignal away from equilibrium.\nThus, if the input is 1µV above equilibrium, the output will be\n100µV below equilibrium. Then the next inverter will amplify again,\nsending a signal 10mV above equilibrium back to the first inverter. The distance will be amplified again,\nnow 1000mV below equilibrium. At this point, you're on the flat part of the curve, so the second inverter will\noutput +5V and the first inverter will output 0V, and the circuit is now stable.</p>\n<p>The point of this is that the equilibrium voltage is an <em>unstable</em> equilibrium,\nso the circuit will eventually settle\ninto the +5V or 0V states. But it may take an arbitrary number of loops through the inverters, depending on\nhow close the starting point was to equilibrium.\n(The signal is continuous, so referring to \"loops\" is a simplification.)\nAlso note that the distance from equilibrium is amplified exponentially with time.\nThis is why the chance of metastability decreases exponentially with time.&#160;<a class=\"footnote-backref\" href=\"#fnref:metastability\" title=\"Jump back to footnote 12 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:metastable-pins\">\n<p>Looking at the die shows that the pins with metastability protection  are <code>INTR</code>, <code>NMI</code>, <code>PEREQ</code>, <code>ERROR#</code>,\nand <code>BUSY#</code>.\nThe <a href=\"http://www.bitsavers.org/components/intel/80386/231732-001_80386_Hardware_Reference_Manual_1986.pdf#page=35\">80386 Hardware Reference Manual</a> lists these same five pins as asynchronous&mdash;I like it when I spot something\nunusual on the die and then discover that it matches an obscure statement in the documentation.\nThe interrupt pins <code>INTR</code> and <code>NMI</code> are asynchronous because they come from external sources that may not\nbe using the 386's clock. But what about \n<code>PEREQ</code>, <code>ERROR#</code>, and <code>BUSY#</code>?\nThese pins are part of the interface with an external math coprocessor (the 287 or 387 chip).\nIn most cases, the coprocessor uses the 386's clock. However, the 387 supported a little-used asynchronous mode\nwhere the processor and the coprocessor could run at different speeds.&#160;<a class=\"footnote-backref\" href=\"#fnref:metastable-pins\" title=\"Jump back to footnote 13 in the text\">&#8617;</a></p>\n</li>\n<li id=\"fn:sense-latch\">\n<p>The 386's metastability flip-flop is constructed with an unusual circuit. It has two latch stages (which is normal),\nbut instead of using two inverters in a loop, it uses a sense-amplifier circuit.\nThe idea of the sense amplifier is that it takes a differential input. When the clock enables the sense amplifier,\nit drives the higher input high and the lower input low (the inputs are also the outputs).\n(Sense amplifiers are used in dynamic RAM chips to amplify the tiny signals from a RAM cell to form a 0 or 1.\nAt the same time, the amplifier refreshes the DRAM cell by generating full voltages.)\nNote that the sense amplifier's inputs also act as outputs; inputs during clock phase 1 and outputs during phase 2.</p>\n<p>The schematic shows one of the latch stages; the complete flip-flop has a second stage, identical\nexcept that the clock phases are switched.\nThis latch is much more complex than the typical 386 latch; 14 transistors versus 6 or 8.\nThe sense amplifier is similar to two inverters in a loop, except they share a limited power current\nand a limited ground current.\nAs one inverter starts to go high, it \"steals\" the supply current from the other. Meanwhile, the other inverter\n\"steals\" the ground current. Thus, a small difference in inputs is amplified, just as in a differential amplifier.\nThus, by combining the amplification of a differential amplifier with the amplification of the inverter loop,\nthis circuit reaches its final state faster than a regular inverter loop.</p>\n<p>In more detail, during the first clock phase, the two inverters at the top generate the inverted and non-inverted\nsignals. (In a metastable situation, these will be close to the midpoint, not binary.)\nDuring the second clock phase, the sense amplifier is activated. You can think of it as a differential amplifier with\ncross-coupling.\nIf one input is slightly higher than the other, the amplifier pulls that input higher and the input lower,\namplifying the difference.\n(The point is to quickly make the difference large enough to resolve the metastability.)</p>\n<p>I couldn't find any latches like this in the literature.\n<a href=\"https://doi.org/10.1109/ISQED.2010.5450482\">Comparative Analysis and Study of Metastability on High-Performance Flip-Flops</a> describes eleven high-performance flip-flops.\nIt includes two flip-flops that are based on sense amplifiers, but their circuits are very different from the 386 circuit.\nPerhaps the 386 circuit is an Intel design that was never publicized.\nIn any case, let me know if this circuit has an official name.&#160;<a class=\"footnote-backref\" href=\"#fnref:sense-latch\" title=\"Jump back to footnote 14 in the text\">&#8617;</a></p>\n</li>\n</ol>\n</div>",
  "id": "tag:blogger.com,1999:blog-6264947694886887540.post-3975009420599472603"
}