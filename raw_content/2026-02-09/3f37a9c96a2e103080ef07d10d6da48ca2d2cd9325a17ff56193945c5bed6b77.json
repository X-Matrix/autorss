{
  "title": "How to make forbidden changes to SQLite tables",
  "link": "https://rakhim.exotext.com/how-to-make-forbidden-changes-to-sqlite-tables",
  "published": "Tue, 24 Dec 2024 11:08:52 GMT",
  "summary": "<p>Sometimes you need to make a change to an SQLite table which is not possible with a simple <code>ALTER</code> command. For example, today I realized that <code>email_verifications</code> table in my DB references <code>users</code> with a foreign key, but does not have <code>ON DELETE CASCADE</code> (I simply forgot to put it in). This makes it impossible to delete a record from <code>users</code> table if there are corresponding records in <code>email_verifications</code>.</p>\n<p>There is a <a href=\"https://stackoverflow.com/questions/13150075/add-on-delete-cascade-behavior-to-an-sqlite3-table-after-it-has-been-created\">hacky</a> way to achieve this, but I prefer this:</p>\n<ol>\n<li>Create a new table with the correct structure (in my case, with <code>ON DELETE CASCADE</code> enabled).</li>\n<li>Copy data from the old table to the new table.</li>\n<li>Rename the old table.</li>\n<li>Rename the new table.</li>\n<li>Drop the old table (if everything is ok).</li>\n</ol>\n<p>It comes down to:</p>\n<pre><code class=\"hljs\">CREATE TABLE IF NOT EXISTS email_verifications_2 (\n    id INTEGER PRIMARY KEY,\n    user_id INTEGER NOT NULL,\n    verification_code TEXT NOT NULL,\n    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE CASCADE\n);\n\nINSERT INTO email_verifications_2 SELECT * FROM email_verifications;\n\nALTER TABLE email_verifications RENAME TO email_verifications_old;\nALTER TABLE email_verifications_2 RENAME TO email_verifications;\n</code></pre><p>If everything is ok, we can drop the old table now:</p>\n<pre><code class=\"hljs\">DROP TABLE email_verifications_old;\n</code></pre>",
  "id": "https://rakhim.exotext.com/how-to-make-forbidden-changes-to-sqlite-tables"
}