{
  "title": "How to build and publish multi-platform Rust binaries via Github actions",
  "link": "https://rakhim.exotext.com/how-to-build-and-publish-multi-platform-rust-binaries",
  "published": "Fri, 20 Dec 2024 11:36:20 GMT",
  "summary": "<p>While developing <a href=\"https://github.com/freetonik/textpod\">Textpod</a> (a simple note-taking app written in Rust), I needed to automate building and publishing on Github. This article (or the corresponding <a href=\"https://github.com/freetonik/textpod/tree/main/.github/workflows\">set of YAML-files</a>) describes the setup which performs the following:</p>\n<ul>\n<li>Build binaries for Windows and Linux</li>\n<li>Build binaries for x86 Macs (Intel) and ARM Macs (arm64, M-chip)</li>\n<li>Add the files to the latest Github release, along with checksums</li>\n<li>Publish to crates.io</li>\n<li>Build a lean Docker image for amd64 and arm64 platforms</li>\n<li>Publish Docker images to Docker Hub</li>\n</ul>\n<p>First, the trigger for these jobs is a release:</p>\n<pre><code class=\"hljs\">on:\n  release:\n    types:\n    - created\n</code></pre><p>The binaries for Linux and Windows can be built in the same Linux environment, using specific rustup targets:</p>\n<pre><code class=\"hljs\">jobs:\n  linux_windows:\n    runs-on: ubuntu-latest\n    steps:\n    - name: Checkout the repository\n      uses: actions/checkout@v2\n\n    - name: Install Linux and Windows Cross Compilers\n      run: sudo apt-get install --yes --no-install-recommends musl-tools gcc-mingw-w64-x86-64-win32\n\n    - name: Install rustup targets\n      run: rustup target add x86_64-unknown-linux-musl x86_64-pc-windows-gnu\n\n    - name: Build the executable\n      run: cargo build --release --target x86_64-unknown-linux-musl --target x86_64-pc-windows-gnu\n\n    - name: Tar x86_64 binary\n      run: tar -czvf textpod-gnu-linux-x86_64.tar.gz -C target/x86_64-unknown-linux-musl/release textpod\n\n    - name: Zip windows binary\n      run: zip -j textpod-windows.zip target/x86_64-pc-windows-gnu/release/textpod.exe\n\n    - name: Generate SHA256 checksums\n      run: |\n        shasum -a 256 textpod-gnu-linux-x86_64.tar.gz &gt; textpod-gnu-linux-x86_64.tar.gz.sha256\n        shasum -a 256 textpod-windows.zip &gt; textpod-windows.zip.sha256\n\n    - name: Upload release binaries\n      uses: alexellis/upload-assets@0.4.0\n      env:\n        GITHUB_TOKEN: ${{ github.token }}\n      with:\n        asset_paths: &#x27;[&quot;textpod-gnu-linux-x86_64.tar.gz&quot;, &quot;textpod-windows.zip&quot;, &quot;textpod-gnu-linux-x86_64.tar.gz.sha256&quot;, &quot;textpod-windows.zip.sha256&quot;]&#x27;\n</code></pre><p>Step 4 (<code>cargo build</code>) produces two binary files. Next two steps archive them into tar.gz and .zip, respectively. Then checksums are calculated and saved into text files. The last step uses a <a href=\"https://github.com/alexellis/upload-assets\"><code>alexellis/upload-assets@0.4.0</code></a> action to attach all 4 files to the latest release. <code>${{ github.token }}</code> is an automatic variable, you don't have to create it manually anywhere.</p>\n<p>Building for macOS is similar, but the job should run on a different platform (<code>runs-on: macos-latest</code>), and we want to have 2 targets: x86 and ARM (i.e. for Intel-based macs and newer ARM-based macs):</p>\n<pre><code class=\"hljs\">rustup target add x86_64-apple-darwin aarch64-apple-darwin\ncargo build --release --target=x86_64-apple-darwin --target=aarch64-apple-darwin\n</code></pre><p>To publish to crates.io, we use the <a href=\"https://github.com/katyo/publish-crates\"><code>katyo/publish-crates@v2</code></a> action:</p>\n<pre><code class=\"hljs\">  crates:\n    runs-on: ubuntu-latest\n    needs: [linux_windows, macos]\n    steps:\n    - uses: actions/checkout@v3\n    - uses: actions-rs/toolchain@v1\n      with:\n        toolchain: stable\n        override: true\n    - uses: katyo/publish-crates@v2\n      with:\n        registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}\n</code></pre><p>The dependency <code>needs: [linux_windows, macos]</code> ensures that this step does not run unless builds for all OS platforms succeeded. You need to create an API token at <a href=\"https://crates.io/settings/tokens\">https://crates.io/settings/tokens</a> add it as the <code>CARGO_REGISTRY_TOKEN</code> variable to your github secrets.</p>\n<p>The last step is to build a Docker image and publish it to Dockerhub:</p>\n<pre><code class=\"hljs\">  docker:\n    runs-on: ubuntu-latest\n    needs: crates\n    steps:\n      -\n        name: Set up QEMU\n        uses: docker/setup-qemu-action@v3\n      -\n        name: Set up Docker Buildx\n        uses: docker/setup-buildx-action@v3\n      -\n        name: Login to Docker Hub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n      -\n        name: Build and push\n        uses: docker/build-push-action@v6\n        with:\n          platforms: linux/amd64,linux/arm64\n          push: true\n          tags: freetonik/textpod:latest\n</code></pre><p>Using the <a href=\"https://github.com/docker/build-push-action\"><code>docker/build-push-action@v6</code></a>, we produce amd64 and arm64 images. Again, you need to store <code>DOCKERHUB_USERNAME</code> and <code>DOCKERHUB_TOKEN</code> as secrets. Note that this step may take a lot of time (often 20-40 minutes).</p>\n<p>As a result, when I create a new release on Github, a normal release page is created which only contains standard links to the source code. A pipeline starts in the background, and a few minutes later the release page gets populated with new files (<a href=\"https://github.com/freetonik/textpod/releases/tag/0.1.4\">example</a>). </p>\n<p>For Docker, we're using <code>rust:alpine</code> base image (see <a href=\"https://github.com/freetonik/textpod/blob/main/Dockerfile\">Dockerfile</a>), which results in images roughly 10 MB in size (see <a href=\"https://hub.docker.com/r/freetonik/textpod/tags\">Docker hub</a>).</p>\n<p>That's it! ðŸ¦€</p>\n<p>P.S. Since the contents of files in the repo may change over time, here is the <a href=\"https://github.com/freetonik/textpod/tree/bdeac83a64a6ad591528ba8dc08f8422c73ff0cb/.github/workflows\">permanent link to the <code>.workflows</code> directory</a> at the point in time when this article was published.</p>",
  "id": "https://rakhim.exotext.com/how-to-build-and-publish-multi-platform-rust-binaries"
}